<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas Claras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para √≠cones "bonitinhos" -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen flex flex-col">

    <!-- Tela de Login -->
    <section id="login-screen" class="absolute inset-0 bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Finan√ßas Claras</h2>
            <p class="text-center text-gray-600 mb-8">Fa√ßa login para acessar suas finan√ßas.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="seuemail@exemplo.com" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="login-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)]" placeholder="********" required>
                </div>
                <button type="submit" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-[var(--color-blue-primary)] hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300">
                    Entrar
                </button>
                <div id="login-error-message" class="text-red-500 text-sm text-center mt-4 hidden"></div>
            </form>
        </div>
    </section>

    <!-- Conte√∫do Principal da Aplica√ß√£o -->
    <div id="app-content" class="hidden flex-grow flex flex-col">
        <!-- Cabe√ßalho Principal (Desktop) -->
        <header class="bg-white p-4 shadow-sm hidden md:block border-b border-gray-200">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">Finan√ßas Claras</h1>
                <nav class="flex items-center space-x-6">
                    <ul class="flex space-x-6">
                        <li><a href="#" data-page="dashboard" class="nav-link text-lg font-medium hover:text-blue-primary transition duration-200 rounded-md py-2 px-3">Vis√£o Geral</a></li>
                        <li><a href="#" data-page="transactions" class="nav-link text-lg font-medium hover:text-blue-primary transition duration-200 rounded-md py-2 px-3">Transa√ß√µes</a></li>
                        <li><a href="#" data-page="chat" class="nav-link text-lg font-medium hover:text-blue-primary transition duration-200 rounded-md py-2 px-3">Assistente IA</a></li>
                        <li><a href="#" data-page="more-options" class="nav-link text-lg font-medium hover:text-blue-primary transition duration-200 rounded-md py-2 px-3">Mais Op√ß√µes</a></li>
                    </ul>
                    <button id="logout-button-desktop" class="px-4 py-2 bg-red-500 text-white font-medium rounded-md hover:bg-red-600 transition duration-300">Sair</button>
                </nav>
            </div>
        </header>

        <main class="container mx-auto p-4 flex-grow pb-32 md:pb-8"> <!-- Ajustado: pb-24 para pb-32 em mobile -->
            <!-- Vis√£o Geral (Dashboard) -->
            <section id="dashboard" class="page-section active">
                <h2 class="text-3xl font-bold mb-2 text-[var(--color-heading-green)]">Vis√£o Geral</h2>
                <p class="text-gray-600 text-lg mb-6">Seu resumo financeiro r√°pido.</p>

                <!-- Cards de Resumo da Vis√£o Geral -->
                <div class="space-y-4 mb-8">
                    <!-- Card Saldo Atual -->
                    <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-base text-gray-600">Saldo Atual</p>
                            <p class="font-bold text-3xl text-[var(--color-blue-primary)]" id="dashboard-current-balance">R$ 0,00</p>
                            <p class="text-sm text-gray-500">Seu dinheiro dispon√≠vel.</p>
                        </div>
                        <!-- √çcone de carteira -->
                        <i class="fa-solid fa-wallet text-3xl"></i>
                    </div>

                    <!-- Card Receitas do M√™s -->
                    <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-base text-gray-600">Receitas do M√™s</p>
                            <p class="font-bold text-3xl text-[var(--color-green-positive)]" id="dashboard-monthly-income">R$ 0,00</p>
                            <p class="text-sm text-gray-500">Total de entradas no m√™s.</p>
                        </div>
                        <!-- √çcone de seta para cima para receitas -->
                        <i class="fa-solid fa-arrow-trend-up text-3xl"></i>
                    </div>

                    <!-- Card Despesas do M√™s -->
                    <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-base text-gray-600">Despesas do M√™s</p>
                            <p class="font-bold text-3xl text-[var(--color-red-negative)]" id="dashboard-monthly-expenses">R$ 0,00</p>
                            <p class="text-sm text-gray-500">Total de sa√≠das no m√™s.</p>
                        </div>
                        <!-- √çcone de seta para baixo para despesas -->
                        <i class="fa-solid fa-arrow-trend-down text-3xl"></i>
                    </div>
                </div>

                <!-- Novo bot√£o para Insights Financeiros -->
                <button id="generate-insights-button" class="w-full sm:w-auto px-6 py-3 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition duration-300 shadow-md mb-8">
                    ‚ú® Gerar Insights Financeiros
                </button>

                <!-- Espa√ßo para Gr√°fico (Placeholder) -->
                <div class="bg-white p-6 rounded-lg shadow-md h-64 flex items-center justify-center text-gray-500 text-lg">
                    [Placeholder para Gr√°fico de Despesas por Categoria]
                </div>
            </section>

            <!-- Transa√ß√µes -->
            <section id="transactions" class="page-section">
                <h2 class="text-3xl font-bold mb-2 text-[var(--color-heading-green)]">Transa√ß√µes</h2>
                <p class="text-gray-600 text-lg mb-6">Suas movimenta√ß√µes e resumo financeiro.</p>

                <!-- Cards de Resumo de Transa√ß√µes -->
                <div class="space-y-4 mb-8">
                    <!-- Card Saldo Atual (agora calculado dinamicamente) -->
                    <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-base text-gray-600">Saldo Atual</p>
                            <p class="font-bold text-3xl text-[var(--color-blue-primary)]" id="transactions-current-balance">R$ 0,00</p>
                            <p class="text-sm text-gray-500">Receitas - Despesas</p>
                        </div>
                        <!-- √çcone de carteira -->
                        <i class="fa-solid fa-wallet text-3xl"></i>
                    </div>

                    <!-- Card Total de Despesas (agora calculado dinamicamente) -->
                    <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-base text-gray-600">Total de Despesas</p>
                            <p class="font-bold text-3xl text-[var(--color-red-negative)]" id="transactions-total-expenses">R$ 0,00</p>
                            <p class="text-sm text-gray-500">Soma de todas as despesas</p>
                        </div>
                        <!-- √çcone de seta para baixo ou similar para despesas -->
                        <i class="fa-solid fa-arrow-trend-down text-3xl"></i>
                    </div>

                    <!-- Card Total Guardado (Metas) - Agora ligado √†s metas reais -->
                    <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-base text-gray-600">Total Guardado (Metas)</p>
                            <p class="font-bold text-3xl text-[var(--color-blue-primary)]" id="transactions-total-goals-saved">R$ 0,00</p>
                            <p class="text-sm text-gray-500">Soma do valor atual das suas metas</p>
                        </div>
                        <!-- √çcone de cofrinho -->
                        <i class="fa-solid fa-piggy-bank text-3xl"></i>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-8">
                    <button id="add-new-transaction-button" class="w-full sm:w-auto px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Adicionar Transa√ß√£o
                    </button>
                </div>

                <!-- Lista de Transa√ß√µes - Agrupadas por Data (agora din√¢micas) -->
                <div id="transactions-list-container" class="relative">
                    <!-- Linha do tempo vertical sutil -->
                    <div class="absolute left-3 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                    <!-- Transa√ß√µes ser√£o renderizadas aqui pelo JavaScript -->
                    <p class="text-center text-gray-500 py-4" id="no-transactions-message">Nenhuma transa√ß√£o cadastrada ainda.</p>
                </div>
            </section>

            <!-- Chat com IA (Assistente) -->
            <section id="chat" class="page-section">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Assistente IA</h2>
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col flex-grow min-h-[300px] relative">
                    <!-- √Årea de Mensagens -->
                    <!-- Adicionado 'pb-20' para que o conte√∫do n√£o seja escondido pela caixa de entrada fixa -->
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 pb-20">
                        <!-- Mensagem da IA de introdu√ß√£o -->
                        <div class="flex justify-start">
                            <div class="bg-gray-100 text-gray-800 p-3 rounded-xl rounded-bl-none max-w-xs md:max-w-md shadow-sm">
                                Ol√°! Sou seu assistente financeiro. Por favor, insira sua chave da API Gemini em "Mais Op√ß√µes" para que eu possa funcionar.
                            </div>
                        </div>
                    </div>
                    <!-- Indicador de Carregamento -->
                    <div id="chat-loading-indicator" class="text-center text-gray-500 py-2 hidden">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
                        Pensando...
                    </div>
                    <!-- Campo de Input de Texto e Bot√µes (Fixo na parte inferior do cont√™iner do chat) -->
                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 flex items-center">
                        <button id="refresh-chat-data-button" class="bg-gray-200 text-gray-600 p-3 rounded-full shadow-md hover:bg-gray-300 transition duration-300 mr-2">
                            <i class="fa-solid fa-arrows-rotate text-lg"></i> <!-- √çcone de Atualizar -->
                        </button>
                        <input type="text" id="chat-input" placeholder="Assistente n√£o configurado..."
                               class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" disabled>
                        <button id="chat-send-button" class="px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-r-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300" disabled>
                            <!-- √çcone de Enviar -->
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Mais Op√ß√µes -->
            <section id="more-options" class="page-section">
                <h2 class="text-3xl font-bold mb-2 text-gray-900">Mais Op√ß√µes</h2>
                <p class="text-gray-600 text-lg mb-6">Explore funcionalidades e configura√ß√µes adicionais.</p>
                
                <div class="space-y-4">
                    <!-- Card/Link para Gerenciamento de API Gemini -->
                    <a href="#" data-page="api-management" class="flex items-center bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                        <i class="fa-solid fa-key text-2xl text-[var(--color-option-icon-green)] mr-4"></i>
                        <div class="flex-grow">
                            <p class="font-semibold text-lg text-gray-800">Chave de API Gemini</p>
                            <p class="text-sm text-gray-600">Gerencie sua chave de acesso para o Assistente IA.</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xl text-gray-400"></i>
                    </a>
                    
                    <!-- Card/Link para Categorias -->
                    <a href="#" data-page="categories-management" class="flex items-center bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                        <i class="fa-solid fa-tags text-2xl text-[var(--color-option-icon-green)] mr-4"></i>
                        <div class="flex-grow">
                            <p class="font-semibold text-lg text-gray-800">Categorias</p>
                            <p class="text-sm text-gray-600">Gerencie suas categorias de gastos e receitas.</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xl text-gray-400"></i>
                    </a>
                    <!-- Card/Link para Metas Financeiras -->
                    <a href="#" data-page="goals-management" class="flex items-center bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                        <i class="fa-solid fa-bullseye text-2xl text-[var(--color-option-icon-green)] mr-4"></i>
                        <div class="flex-grow">
                            <p class="font-semibold text-lg text-gray-800">Metas Financeiras</p>
                            <p class="text-sm text-gray-600">Defina e acompanhe seus objetivos financeiros.</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xl text-gray-400"></i>
                    </a>
                    <!-- Card/Link para Or√ßamento -->
                    <a href="#" data-page="budget-management" class="flex items-center bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                        <i class="fa-solid fa-wallet text-2xl text-[var(--color-option-icon-green)] mr-4"></i>
                        <div class="flex-grow">
                            <p class="font-semibold text-lg text-gray-800">Or√ßamento</p>
                            <p class="text-sm text-gray-600">Defina e acompanhe seu or√ßamento mensal.</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xl text-gray-400"></i>
                    </a>
                    <!-- Card/Link para Configurar IA (ATUALIZADO) -->
                    <a href="#" data-page="ai-config" class="flex items-center bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                        <i class="fa-solid fa-brain text-2xl text-[var(--color-option-icon-green)] mr-4"></i>
                        <div class="flex-grow">
                            <p class="font-semibold text-lg text-gray-800">Configurar IA</p>
                            <p class="text-sm text-gray-600">Personalize a persona e personalidade do assistente financeiro.</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xl text-gray-400"></i>
                    </a>
                    <!-- Bot√£o de Sair (Mobile) -->
                    <button id="logout-button-mobile" class="w-full px-6 py-3 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 shadow-md flex items-center justify-center">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i> Sair
                    </button>
                </div>
            </section>

            <!-- Se√ß√£o de Gerenciamento de Categorias (Atualizada) -->
            <section id="categories-management" class="page-section">
                <h2 class="text-3xl font-bold mb-2 text-gray-900">Categorias</h2>
                <p class="text-gray-600 text-lg mb-6">Gerencie suas categorias de transa√ß√µes.</p>

                <div class="mb-6">
                    <input type="text" id="category-search-input" placeholder="Buscar categoria..."
                           class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]">
                </div>

                <button id="add-new-category-button" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600 transition duration-300 shadow-md flex items-center justify-center mb-8">
                    <i class="fa-solid fa-plus mr-2"></i>
                    Nova Categoria
                </button>

                <div id="category-list-container" class="space-y-4">
                    <!-- Categorias ser√£o renderizadas aqui pelo JavaScript -->
                </div>
            </section>

            <!-- Se√ß√£o de Gerenciamento de Metas (Atualizada) -->
            <section id="goals-management" class="page-section">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Minhas Metas Financeiras</h2>
                <p class="text-gray-600 text-lg mb-6">Defina e acompanhe seus objetivos financeiros de longo e curto prazo.</p>
                <button id="add-new-goal-button" class="px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md mb-8">
                    Adicionar Nova Meta
                </button>
                <div id="goal-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Metas ser√£o renderizadas aqui pelo JavaScript -->
                    <p class="text-center text-gray-500 py-4 col-span-full" id="no-goals-message">Nenhuma meta cadastrada ainda.</p>
                </div>
            </section>

            <!-- Se√ß√£o de Or√ßamento -->
            <section id="budget-management" class="page-section">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Meu Or√ßamento</h2>
                <p class="text-gray-600 text-lg mb-6">Gerencie seus or√ßamentos mensais por categoria para controlar seus gastos.</p>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-8">
                    <button id="configure-budget-button" class="w-full sm:w-auto px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Configurar Or√ßamento Mensal
                    </button>
                    <button id="optimize-budget-button" class="w-full sm:w-auto px-6 py-3 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 shadow-md flex items-center justify-center">
                        <i class="fa-solid fa-lightbulb mr-2"></i> Otimizar Or√ßamento com IA
                    </button>
                </div>
                <div id="budget-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Or√ßamentos ser√£o renderizados aqui pelo JavaScript -->
                    <p class="text-center text-gray-500 py-4 col-span-full" id="no-budgets-message">Nenhum or√ßamento configurado ainda.</p>
                </div>
            </section>

            <!-- Se√ß√£o de Configura√ß√£o da IA (ATUALIZADA) -->
            <section id="ai-config" class="page-section">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Configurar Assistente IA</h2>
                <p class="text-gray-600 text-lg mb-6">Defina a persona e personalidade do seu Assistente IA para uma experi√™ncia personalizada.</p>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="mb-4">
                        <label for="ai-persona" class="block text-sm font-medium text-gray-700 mb-1">Quem √© a IA (Persona):</label>
                        <textarea id="ai-persona" rows="3" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-[var(--color-blue-primary)] focus:border-[var(--color-blue-primary)]" placeholder="Ex: Um assistente financeiro especialista em organiza√ß√£o de gastos e investimentos, focado em educa√ß√£o financeira e otimiza√ß√£o de or√ßamentos."></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="ai-personality" class="block text-sm font-medium text-gray-700 mb-1">Personalidade da IA:</label>
                        <input type="text" id="ai-personality" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-[var(--color-blue-primary)] focus:border-[var(--color-blue-primary)]" placeholder="Ex: Direto, objetivo, encorajador, ocasionalmente divertido.">
                    </div>
                    <button id="save-ai-config-button" class="px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Salvar Configura√ß√µes da IA
                    </button>
                    <div id="ai-config-status-message" class="mt-4 text-sm font-medium hidden"></div>
                </div>
            </section>

        </main>

        <!-- Barra de Navega√ß√£o Inferior (Mobile) -->
        <footer class="mobile-nav-bar md:hidden">
            <a href="#" data-page="dashboard" class="mobile-nav-item active">
                <i class="fa-solid fa-table-columns text-xl"></i>
                <span>Vis√£o Geral</span>
            </a>
            <a href="#" data-page="transactions" class="mobile-nav-item">
                <i class="fa-solid fa-list-check text-xl"></i>
                <span>Transa√ß√µes</span>
            </a>
            <a href="#" data-page="chat" class="mobile-nav-item">
                <!-- √çcone do Assistente IA (Bot) -->
                <i class="fa-solid fa-robot text-xl"></i>
                <span>Assistente</span>
            </a>
            <a href="#" data-page="more-options" class="mobile-nav-item">
                <i class="fa-solid fa-ellipsis text-xl"></i>
                <span>Mais</span>
            </a>
        </footer>
    </div>

    <!-- Modal para Adicionar/Editar Categoria -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-category-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-900" id="category-modal-title">Adicionar Nova Categoria</h3>
            <form id="category-form">
                <input type="hidden" id="category-id">
                <div class="mb-4">
                    <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Categoria</label>
                    <input type="text" id="category-name" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="category-type" value="Despesa" class="form-radio text-red-500" checked>
                            <span class="ml-2 text-gray-700">Despesa</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="category-type" value="Receita" class="form-radio text-green-500">
                            <span class="ml-2 text-gray-700">Receita</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cor</label>
                    <div id="color-palette" class="color-palette">
                        <!-- Cores ser√£o geradas via JavaScript -->
                    </div>
                    <input type="hidden" id="selected-color" value="#F8B1A0"> <!-- Cor padr√£o para Receita, pegando uma do novo conjunto -->
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-category-button" class="px-6 py-3 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Salvar Categoria
                    </button>
                </div>
                <div id="category-save-status-message" class="mt-4 text-sm font-medium hidden"></div>
            </form>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Transa√ß√£o (NOVO) -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-transaction-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-900" id="transaction-modal-title">Adicionar Nova Transa√ß√£o</h3>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id">
                <div class="mb-4">
                    <label for="transaction-description" class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                    <input type="text" id="transaction-description" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                </div>
                <div class="mb-4">
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor</label>
                    <input type="text" id="transaction-amount" inputmode="numeric" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                </div>
                <div class="mb-4">
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="transaction-date" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="transaction-type" value="Despesa" class="form-radio text-red-500" checked>
                            <span class="ml-2 text-gray-700">Despesa</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="transaction-type" value="Receita" class="form-radio text-green-500">
                            <span class="ml-2 text-gray-700">Receita</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4" id="transaction-category-container">
                    <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                    <select id="transaction-category" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                        <!-- Categorias e Metas (para Receita) ser√£o carregadas via JavaScript -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="transaction-status" class="block text-sm font-medium text-gray-700 mb-1">Status do Pagamento</label>
                    <select id="transaction-status" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                        <!-- Op√ß√µes de status ser√£o carregadas via JavaScript -->
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-transaction-button" class="px-6 py-3 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Salvar Transa√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Meta (NOVO) -->
    <div id="goal-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-goal-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-900" id="goal-modal-title">Adicionar Nova Meta Financeira</h3>
            <form id="goal-form">
                <input type="hidden" id="goal-id">
                <div class="mb-4">
                    <label for="goal-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Meta</label>
                    <input type="text" id="goal-name" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                </div>
                <div class="mb-4">
                    <label for="goal-target-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor Alvo</label>
                    <input type="text" id="goal-target-amount" inputmode="numeric" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                </div>
                <div class="mb-4">
                    <label for="goal-current-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor Atual Guardado</label>
                    <input type="text" id="goal-current-amount" inputmode="numeric" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-goal-button" class="px-6 py-3 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-3 bg-[var(--color-blue-primary)] text-white font-medium rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--color-blue-primary)] transition duration-300 shadow-md">
                        Salvar Meta
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal para Insights Financeiros -->
    <div id="insights-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-insights-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-900">‚ú® Seus Insights Financeiros</h3>
            <div id="insights-content" class="min-h-[150px] max-h-[400px] overflow-y-auto bg-gray-50 p-4 rounded-md text-gray-700 leading-relaxed">
                <!-- Insights da IA ser√£o carregados aqui -->
                <div id="insights-loading-indicator" class="text-center text-gray-500 py-2 hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
                    Analisando suas finan√ßas...
                </div>
                <p id="insights-text" class="whitespace-pre-wrap"></p>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" id="close-insights-button" class="px-6 py-3 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-300 shadow-md">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Gerenciamento de Chaves de API (AGORA COM UM CAMPO) -->
    <div id="api-keys-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-api-keys-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-900">Gerenciamento da Chave de API Gemini</h3>
            <div id="api-modal-status-message" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 hidden" role="alert">
                <p class="font-bold">Status da API:</p>
                <p id="api-modal-message-text"></p>
            </div>
            <div class="space-y-4 mb-4">
                <input type="text" id="modal-api-key" placeholder="Sua Chave API Gemini" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--color-blue-primary)]">
            </div>
            <div class="flex justify-end">
                <button type="button" id="save-api-keys-modal-button" class="px-6 py-3 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 shadow-md">
                    Salvar Chave
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Otimiza√ß√£o de Or√ßamento com IA -->
    <div id="budget-optimization-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-budget-optimization-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-900">üí° Sugest√µes de Otimiza√ß√£o de Or√ßamento</h3>
            <div id="budget-optimization-content" class="min-h-[150px] max-h-[400px] overflow-y-auto bg-gray-50 p-4 rounded-md text-gray-700 leading-relaxed">
                <div id="budget-optimization-loading-indicator" class="text-center text-gray-500 py-2 hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
                    Analisando seu or√ßamento para otimiza√ß√£o...
                </div>
                <p id="budget-optimization-text" class="whitespace-pre-wrap"></p>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" id="close-budget-optimization-button" class="px-6 py-3 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-300 shadow-md">
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <!-- Modal de Confirma√ß√£o Gen√©rico -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-900" id="confirmation-modal-title">Confirma√ß√£o</h3>
            <p id="confirmation-modal-message" class="text-gray-700 mb-6">Voc√™ tem certeza que deseja realizar esta a√ß√£o?</p>
            <div class="confirmation-modal-buttons">
                <button id="cancel-confirmation-button" class="cancel-delete">Cancelar</button>
                <button id="confirm-action-button" class="confirm-delete">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa os m√≥dulos necess√°rios do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais do ambiente Canvas (preenchidas em tempo de execu√ß√£o)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ATEN√á√ÉO: Firebase Config hardcodada para depura√ß√£o.
        // Substitua com seus valores reais do Firebase Console se precisar mudar de projeto.
        const firebaseConfig = {
            apiKey: "AIzaSyBEuFW_VQEx_smJUOxCsF0Jug_lnzUA2aw",
            authDomain: "offline-d2e68.firebaseapp.com",
            projectId: "offline-d2e68",
            storageBucket: "offline-d2e68.firebasestorage.app",
            messagingSenderId: "524684058670",
            appId: "1:524684058670:web:5141130aee53e059cc7fbf"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inst√¢ncias do Firebase
        let app;
        let db;
        let auth;
        let userId = null; 
        let isAuthReady = false; 

        // Arrays para armazenar os dados do usu√°rio
        let categories = []; 
        let transactions = [];
        let goals = []; 
        let budgets = []; 

        // Configura√ß√µes da IA
        let aiConfig = {
            // Defini√ß√£o de Persona (valores padr√£o, ser√£o carregados do Firestore)
            persona: "Voc√™ √© meu assistente financeiro pessoal, especializado em organiza√ß√£o de gastos, planejamento financeiro e educa√ß√£o financeira. Acompanho seus dados em tempo real e uso regras como a 50-30-20 para te ajudar a tomar decis√µes mais inteligentes com o seu dinheiro. Meu papel √© analisar suas entradas e sa√≠das, identificar padr√µes, te avisar quando voc√™ sair do ideal e propor ajustes pr√°ticos. Se tiver dinheiro sobrando, mostro como usar com intelig√™ncia. Se faltar, te mostro onde cortar. Se voc√™ n√£o tiver registrado seus gastos do dia ou n√£o tiver dados o suficiente, vou te lembrar de atualizar. Sem informa√ß√£o, n√£o consigo te orientar. Meu objetivo √© ser o c√©rebro da sua vida financeira ‚Äî mas preciso que voc√™ alimente ele.",
            // Personalidade da IA (valores padr√£o, ser√£o carregados do Firestore)
            personality: "Direto e firme. Quando tiver que dar uma not√≠cia ruim ou um feedback direto, n√£o floreie, v√° direto ao ponto. Ap√≥s entregar a realidade, seja construtivo e ofere√ßa sugest√µes claras para melhorar. Se o usu√°rio n√£o tiver dados suficientes para uma an√°lise aprofundada, informe de forma clara que mais dados s√£o necess√°rios. Sua fun√ß√£o √© educar e otimizar, n√£o suavizar a realidade financeira. Use emojis com modera√ß√£o e apenas para dar um leve toque de leveza ap√≥s uma informa√ß√£o s√©ria ou para real√ßar um ponto positivo/a√ß√£o recomendada."
        };

        let geminiApiKey = ''; 
        let chatHistory = []; 
        let isSendingMessage = false;
        let isGeminiApiReady = false; 

        // Flag e armazenamento para dados financeiros para a IA
        let hasConsultedFinancialData = false;
        let lastFinancialDataString = ''; 

        // Cores para o seletor de categorias - EXPANDIDAS E SIMILARES √Ä IMAGEM DO USU√ÅRIO
        const categoryColors = [
            // Linha 1 da imagem (Vermelhos/Rosas/Laranjas)
            '#E91E63', '#F06292', '#F48FB1', '#F8B1A0', '#EF5350', '#E53935', '#D32F2F', '#C62828',
            // Linha 2 da imagem (Marrons/Vermelhos Escuros/Laranjas)
            '#795548', '#8D6E63', '#A1887F', '#BCAAA4', '#FF8A65', '#FF7043', '#FF5722', '#F4511E',
            // Linha 3 da imagem (Laranjas/Amarelos)
            '#FFCC80', '#FFB74D', '#FFA726', '#FB8C00', '#FFEA00', '#FFD600', '#FFC107', '#FFAB00',
            // Linha 4 da imagem (Verdes/Azuis Esverdeados)
            '#4CAF50', '#66BB6A', '#8BC34A', '#CDDC39', '#009688', '#26A69A', '#4DB6AC', '#80CBC4',
            // Linha 5 da imagem (Azuis/Cianos)
            '#00BCD4', '#26C6DA', '#4DD0E1', '#80DEEA', '#2196F3', '#42A5F5', '#64B5F6', '#90CAF9',
            // Linha 6 da imagem (Azuis Escuros/Roxos)
            '#1A237E', '#283593', '#303F9F', '#3F51B5', '#673AB7', '#7E57C2', '#9575CD', '#B39DDB',
            // Linha 7 da imagem (Roxos/Cinzas/Pretos)
            '#BA68C8', '#CE93D8', '#E1BEE7', '#F3E5F5', '#9E9E9E', '#BDBDBD', '#E0E0E0', '#424242' // Adicionando alguns cinzas para mais variedade
        ];


        // --- Fun√ß√µes Auxiliares ---

        // Fun√ß√£o para gerar UUIDs (IDs √∫nicos)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Formata um valor num√©rico para moeda brasileira
        function formatCurrency(value) {
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Limpa e formata o input de valor para moeda brasileira
        function formatCurrencyInput(inputElement) {
            let value = inputElement.value.replace(/\D/g, ''); 
            
            if (value.length === 0) {
                inputElement.value = '';
                return;
            }

            value = (parseInt(value, 10) / 100).toFixed(2); 
            value = value.replace('.', ','); 
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); 

            inputElement.value = value;
        }

        // JavaScript para simular a navega√ß√£o entre as se√ß√µes/p√°ginas
        document.addEventListener('DOMContentLoaded', async () => {
            // Elementos da Tela de Login
            const loginScreen = document.getElementById('login-screen');
            const loginForm = document.getElementById('login-form');
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginErrorMessage = document.getElementById('login-error-message');
            const appContent = document.getElementById('app-content');

            // Elementos do Modal de Confirma√ß√£o Gen√©rico
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationModalTitle = document.getElementById('confirmation-modal-title');
            const confirmationModalMessage = document.getElementById('confirmation-modal-message');
            const cancelConfirmationButton = document.getElementById('cancel-confirmation-button');
            const confirmActionButton = document.getElementById('confirm-action-button');
            let confirmActionCallback = null; // Fun√ß√£o a ser executada ao confirmar

            // Seleciona todos os elementos que podem atuar como links de navega√ß√£o.
            const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-item, [data-page]');
            const pageSections = document.querySelectorAll('.page-section');

            // Fun√ß√£o para exibir um modal de confirma√ß√£o customizado
            function showConfirmationModal(title, message, callback) {
                confirmationModalTitle.textContent = title;
                confirmationModalMessage.textContent = message;
                confirmActionCallback = callback;
                confirmationModal.classList.add('active');
            }

            // Fun√ß√£o para fechar o modal de confirma√ß√£o
            function closeConfirmationModal() {
                confirmationModal.classList.remove('active');
                confirmActionCallback = null; // Limpa o callback
            }

            // Event listener para o bot√£o de confirmar no modal de confirma√ß√£o
            confirmActionButton.addEventListener('click', () => {
                if (confirmActionCallback) {
                    confirmActionCallback();
                }
                closeConfirmationModal();
            });

            // Event listener para o bot√£o de cancelar no modal de confirma√ß√£o
            cancelConfirmationButton.addEventListener('click', closeConfirmationModal);


            // --- Fun√ß√µes de Persist√™ncia (Firebase Firestore) ---
            // Caminhos base para os dados do usu√°rio no Firestore.
            // Fun√ß√£o para obter refer√™ncia a uma cole√ß√£o (para m√∫ltiplos documentos, ex: transa√ß√µes)
            const getUserCollectionRef = (collectionName) => {
                // Certifica-se de que userId est√° definido antes de criar a refer√™ncia
                if (!userId) {
                    console.error("userId n√£o est√° definido. N√£o √© poss√≠vel criar refer√™ncia de cole√ß√£o.");
                    return null;
                }
                return collection(db, `artifacts/${appId}/users/${userId}`, collectionName);
            };

            // Fun√ß√£o para obter refer√™ncia a um documento espec√≠fico (para dados armazenados como um √∫nico doc, ex: categorias, metas, or√ßamentos, aiConfig)
            const getUserDocumentRef = (collectionName, docName) => {
                // Certifica-se de que userId est√° definido antes de criar a refer√™ncia
                if (!userId) {
                    console.error("userId n√£o est√° definido. N√£o √© poss√≠vel criar refer√™ncia de documento.");
                    return null;
                }
                return doc(db, `artifacts/${appId}/users/${userId}`, collectionName, docName);
            };

            // Elementos do Chat
            const chatMessagesDiv = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send-button'); 
            const chatLoadingIndicator = document.getElementById('chat-loading-indicator');
            const refreshChatDataButton = document.getElementById('refresh-chat-data-button');

            // Elementos das Categorias
            const addCategoryButton = document.getElementById('add-new-category-button');
            const categoryListContainer = document.getElementById('category-list-container');
            const categoryModal = document.getElementById('category-modal');
            const closeCategoryModalButton = document.getElementById('close-category-modal');
            const cancelCategoryButton = document.getElementById('cancel-category-button');
            const categoryForm = document.getElementById('category-form');
            const categoryIdInput = document.getElementById('category-id');
            const categoryNameInput = document.getElementById('category-name');
            const categoryModalTitle = document.getElementById('category-modal-title');
            const colorPalette = document.getElementById('color-palette');
            const selectedColorInput = document.getElementById('selected-color');
            const categorySearchInput = document.getElementById('category-search-input');
            const categorySaveStatusMessage = document.getElementById('category-save-status-message');

            // Elementos das Transa√ß√µes
            const addNewTransactionButton = document.getElementById('add-new-transaction-button');
            const transactionsListContainer = document.getElementById('transactions-list-container');
            const transactionModal = document.getElementById('transaction-modal');
            const closeTransactionModalButton = document.getElementById('close-transaction-modal');
            const cancelTransactionButton = document.getElementById('cancel-transaction-button');
            const transactionForm = document.getElementById('transaction-form');
            const transactionIdInput = document.getElementById('transaction-id');
            const transactionDescriptionInput = document.getElementById('transaction-description');
            const transactionAmountInput = document.getElementById('transaction-amount');
            const transactionDateInput = document.getElementById('transaction-date');
            const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
            const transactionCategoryContainer = document.getElementById('transaction-category-container'); 
            const transactionCategorySelect = document.getElementById('transaction-category');
            const transactionStatusSelect = document.getElementById('transaction-status');
            const transactionModalTitle = document.getElementById('transaction-modal-title');
            const noTransactionsMessage = document.getElementById('no-transactions-message');

            // Elementos das Metas
            const addNewGoalButton = document.getElementById('add-new-goal-button');
            const goalListContainer = document.getElementById('goal-list-container');
            const goalModal = document.getElementById('goal-modal');
            const closeGoalModalButton = document.getElementById('close-goal-modal');
            const cancelGoalButton = document.getElementById('cancel-goal-button');
            const goalForm = document.getElementById('goal-form');
            const goalIdInput = document.getElementById('goal-id');
            const goalNameInput = document.getElementById('goal-name');
            const goalTargetAmountInput = document.getElementById('goal-target-amount');
            const goalCurrentAmountInput = document.getElementById('goal-current-amount');
            const goalModalTitle = document.getElementById('goal-modal-title');
            const noGoalsMessage = document.getElementById('no-goals-message');

            // Elementos do Dashboard
            const dashboardCurrentBalance = document.getElementById('dashboard-current-balance');
            const dashboardMonthlyIncome = document.getElementById('dashboard-monthly-income');
            const dashboardMonthlyExpenses = document.getElementById('dashboard-monthly-expenses');

            // Elementos da Se√ß√£o de Transa√ß√µes (Resumo)
            const transactionsCurrentBalance = document.getElementById('transactions-current-balance');
            const transactionsTotalExpenses = document.getElementById('transactions-total-expenses');
            const transactionsTotalGoalsSaved = document.getElementById('transactions-total-goals-saved');

            // Elementos do Or√ßamento
            const configureBudgetButton = document.getElementById('configure-budget-button'); // Bot√£o existente
            const optimizeBudgetButton = document.getElementById('optimize-budget-button'); // NOVO: Bot√£o de Otimiza√ß√£o de Or√ßamento
            const budgetListContainer = document.getElementById('budget-list-container');
            const noBudgetsMessage = document.getElementById('no-budgets-message');

            // Elementos do Insights Modal
            const insightsModal = document.getElementById('insights-modal');
            const closeInsightsModalButton = document.getElementById('close-insights-modal'); 
            const closeInsightsButton = document.getElementById('close-insights-button');
            const insightsContent = document.getElementById('insights-content');
            const insightsLoadingIndicator = document.getElementById('insights-loading-indicator');
            const insightsText = document.getElementById('insights-text');

            // Elementos do Modal de Otimiza√ß√£o de Or√ßamento (NOVO)
            const budgetOptimizationModal = document.getElementById('budget-optimization-modal');
            const closeBudgetOptimizationModalButton = document.getElementById('close-budget-optimization-modal');
            const closeBudgetOptimizationButton = document.getElementById('close-budget-optimization-button');
            const budgetOptimizationContent = document.getElementById('budget-optimization-content');
            const budgetOptimizationLoadingIndicator = document.getElementById('budget-optimization-loading-indicator');
            const budgetOptimizationText = document.getElementById('budget-optimization-text');


            // Elementos do Modal de Chave de API
            const apiManagementLink = document.querySelector('[data-page="api-management"]');
            const apiKeysModal = document.getElementById('api-keys-modal');
            const closeApiKeysModalButton = document.getElementById('close-api-keys-modal');
            const modalApiKeyInput = document.getElementById('modal-api-key');
            const saveApiKeysModalButton = document.getElementById('save-api-keys-modal-button');
            const apiModalStatusMessageDiv = document.getElementById('api-modal-status-message');
            const apiModalMessageText = document.getElementById('api-modal-message-text');

            // Elementos da Configura√ß√£o de IA
            const aiPersonaInput = document.getElementById('ai-persona');
            const aiPersonalityInput = document.getElementById('ai-personality');
            const saveAiConfigButton = document.getElementById('save-ai-config-button');
            const aiConfigStatusMessage = document.getElementById('ai-config-status-message');

            // Bot√µes de Sair
            const logoutButtonDesktop = document.getElementById('logout-button-desktop');
            const logoutButtonMobile = document.getElementById('logout-button-mobile');

            // Carrega todos os dados do Firestore
            async function loadAllDataFromFirestore() {
                console.log("loadAllDataFromFirestore called. userId:", userId, "isAuthReady:", isAuthReady);
                if (!isAuthReady || !userId) {
                    console.warn("Autentica√ß√£o n√£o pronta ou userId ausente para carregar dados do Firestore. Abortando load.");
                    return;
                }

                // Listener para AI Config - Usa getUserDocumentRef
                onSnapshot(getUserDocumentRef('settings', 'aiConfig'), (docSnap) => {
                    if (docSnap.exists()) {
                        aiConfig = { ...aiConfig, ...docSnap.data() }; // Mescla com os defaults
                        aiPersonaInput.value = aiConfig.persona;
                        aiPersonalityInput.value = aiConfig.personality;
                        console.log("AI Config carregada do Firestore.");
                    } else {
                        console.log("AI Config n√£o encontrada, salvando padr√£o.");
                        setDoc(getUserDocumentRef('settings', 'aiConfig'), aiConfig); // Usa getUserDocumentRef para salvar
                    }
                }, (error) => {
                    console.error("Erro ao carregar AI Config do Firestore:", error);
                });

                // Listener para Categorias - Usa getUserDocumentRef
                onSnapshot(getUserDocumentRef('categories', 'userCategories'), (docSnap) => {
                    if (docSnap.exists() && docSnap.data().items) {
                        categories = docSnap.data().items;
                        console.log("Categorias carregadas do Firestore.");
                        renderCategories(categorySearchInput.value);
                        if (transactionModal.classList.contains('active')) {
                            populateTransactionCategories(document.querySelector('input[name="transaction-type"]:checked').value);
                        }
                    } else { // Se n√£o existir ou estiver vazio, inicializa como array vazio
                        categories = [];
                        console.log("Categorias n√£o encontradas ou vazias, inicializando como array vazio.");
                        saveCategories(); // Salva para criar o documento vazio se n√£o existir
                        renderCategories(categorySearchInput.value);
                    }
                }, (error) => {
                    console.error("Erro ao carregar Categorias do Firestore:", error);
                });

                // Listener para Metas - Usa getUserDocumentRef
                onSnapshot(getUserDocumentRef('goals', 'userGoals'), (docSnap) => {
                    if (docSnap.exists() && docSnap.data().items) {
                        goals = docSnap.data().items;
                        console.log("Metas carregadas do Firestore.");
                        renderGoals();
                        updateDashboardAndTransactionSummaries();
                        if (transactionModal.classList.contains('active')) {
                            populateTransactionCategories(document.querySelector('input[name="transaction-type"]:checked').value);
                        }
                    } else { // Se n√£o existir ou estiver vazio, inicializa como array vazio
                        goals = [];
                        console.log("Metas n√£o encontradas ou vazias, inicializando como array vazio.");
                        saveGoals(); // Salva para criar o documento vazio se n√£o existir
                        renderGoals();
                        updateDashboardAndTransactionSummaries();
                    }
                }, (error) => {
                    console.error("Erro ao carregar Metas do Firestore:", error);
                });

                // Listener para Or√ßamentos - Usa getUserDocumentRef
                onSnapshot(getUserDocumentRef('budgets', 'userBudgets'), (docSnap) => {
                    if (docSnap.exists() && docSnap.data().items) {
                        budgets = docSnap.data().items;
                        console.log("Or√ßamentos carregados do Firestore.");
                        renderBudgets();
                    } else { // Se n√£o existir ou estiver vazio, inicializa como array vazio
                        budgets = [];
                        console.log("Or√ßamentos n√£o encontrados ou vazios, inicializando como array vazio.");
                        saveBudgets(); // Salva para criar o documento vazio se n√£o existir
                        renderBudgets();
                    }
                }, (error) => {
                    console.error("Erro ao carregar Or√ßamentos do Firestore:", error);
                });

                // Listener para Transa√ß√µes - Usa getUserCollectionRef
                const transactionsColRef = getUserCollectionRef('transactions');
                if (transactionsColRef) { // Verifica se a refer√™ncia foi criada com sucesso
                    onSnapshot(query(transactionsColRef, orderBy('date', 'desc')), (querySnapshot) => {
                        transactions = [];
                        querySnapshot.forEach((doc) => {
                            transactions.push({ id: doc.id, ...doc.data() });
                        });
                        console.log("Transa√ß√µes carregadas do Firestore.");
                        renderTransactions();
                        updateDashboardAndTransactionSummaries();
                    }, (error) => {
                        console.error("Erro ao carregar Transa√ß√µes do Firestore:", error);
                    });
                }


                loadApiKey();
            }

            // Salva a configura√ß√£o da IA no Firestore
            async function saveAiConfig() {
                if (!isAuthReady || !userId) { console.warn("Autentica√ß√£o n√£o pronta ou userId ausente."); return; }
                try {
                    const aiConfigRef = getUserDocumentRef('settings', 'aiConfig');
                    if (aiConfigRef) { // Verifica se a refer√™ncia foi criada com sucesso
                        await setDoc(aiConfigRef, aiConfig); 
                        aiConfigStatusMessage.textContent = 'Configura√ß√µes da IA salvas no Firebase!';
                        aiConfigStatusMessage.className = 'mt-4 text-sm font-medium text-green-700 block';
                        setTimeout(() => { aiConfigStatusMessage.classList.add('hidden'); }, 3000);
                    }
                } catch (error) {
                    console.error("Erro ao salvar AI Config:", error);
                    aiConfigStatusMessage.textContent = `Erro ao salvar: ${error.message}`;
                    aiConfigStatusMessage.className = 'mt-4 text-sm font-medium text-red-700 block';
                }
            }

            // Salva categorias no Firestore (como um √∫nico documento com array)
            async function saveCategories() {
                if (!isAuthReady || !userId) { 
                    console.warn("saveCategories: Autentica√ß√£o n√£o pronta ou userId ausente. Tentando salvar localmente por agora.");
                    displayCategorySaveStatus('Erro: Autentica√ß√£o n√£o pronta para salvar no banco.', 'error');
                    return; 
                }
                try {
                    const userCategoriesRef = getUserDocumentRef('categories', 'userCategories');
                    if (userCategoriesRef) {
                        await setDoc(userCategoriesRef, { items: categories || [] }); 
                        console.log("saveCategories: Categorias salvas com sucesso no Firestore!");
                        displayCategorySaveStatus('Categoria salva com sucesso! &#x1F389;', 'success');
                    }
                } catch (error) {
                    console.error("saveCategories: Erro ao salvar Categorias no Firestore:", error);
                    displayCategorySaveStatus(`Erro ao salvar: ${error.message}`, 'error');
                }
            }

            // Salva uma transa√ß√£o individual no Firestore (adicione ou atualize)
            async function saveTransaction(transactionData) {
                if (!isAuthReady || !userId) { console.warn("Autentica√ß√£o n√£o pronta ou userId ausente."); return; }
                try {
                    const transactionsColRef = getUserCollectionRef('transactions');
                    if (transactionsColRef) {
                        if (transactionData.id) {
                            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, transactionData.id), transactionData);
                        } else {
                            await addDoc(transactionsColRef, transactionData);
                        }
                    }
                } catch (error) {
                    console.error("Erro ao salvar Transa√ß√£o:", error);
                }
            }

            // Deleta uma transa√ß√£o individual do Firestore
            async function deleteTransactionFromFirestore(id) {
                if (!isAuthReady || !userId) { console.warn("Autentica√ß√£o n√£o pronta ou userId ausente."); return; }
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id));
                } catch (error) {
                    console.error("Erro ao deletar Transa√ß√£o:", error);
                }
            }

            // Salva metas no Firestore (como um √∫nico documento com array)
            async function saveGoals() {
                if (!isAuthReady || !userId) { console.warn("Autentica√ß√£o n√£o pronta ou userId ausente."); return; }
                try {
                    const userGoalsRef = getUserDocumentRef('goals', 'userGoals');
                    if (userGoalsRef) {
                        await setDoc(userGoalsRef, { items: goals || [] }); 
                    }
                } catch (error) {
                    console.error("Erro ao salvar Metas:", error);
                }
            }

            // Salva or√ßamentos no Firestore (como um √∫nico documento com array)
            async function saveBudgets() {
                if (!isAuthReady || !userId) { console.warn("Autentica√ß√£o n√£o pronta ou userId ausente."); return; }
                try {
                    const userBudgetsRef = getUserDocumentRef('budgets', 'userBudgets');
                    if (userBudgetsRef) {
                        await setDoc(userBudgetsRef, { items: budgets || [] }); 
                    }
                } catch (error) {
                    console.error("Erro ao salvar Or√ßamentos:", error);
                }
            }
            // --- FIM das Fun√ß√µes de Persist√™ncia (Firebase Firestore) ---

            await initializeFirebase();
            
            
            function loadApiKey() {
                const storedKey = localStorage.getItem('geminiApiKey');
                if (storedKey) {
                    geminiApiKey = storedKey;
                    modalApiKeyInput.value = geminiApiKey;
                    updateApiModalStatus(`Chave de API carregada: ${geminiApiKey.substring(0, 10)}...`, 'info');
                    isGeminiApiReady = true;
                } else {
                    geminiApiKey = '';
                    updateApiModalStatus("Nenhuma chave de API salva ainda. Por favor, insira e salve.", "info");
                    isGeminiApiReady = false;
                }
                updateChatUIState();
            }

            function saveApiKey() {
                const keyToSave = modalApiKeyInput.value.trim();
                localStorage.setItem('geminiApiKey', keyToSave);
                geminiApiKey = keyToSave;
                updateApiModalStatus("Chave de API salva com sucesso! &#x1F389;", "success");
                isGeminiApiReady = true;
                updateChatUIState();
            }

            // --- Fun√ß√µes de UI e Navega√ß√£o ---

            // Fun√ß√£o para exibir a p√°gina correta
            function showPage(pageId) {
                pageSections.forEach(section => {
                    section.classList.remove('active');
                });
                const activePage = document.getElementById(pageId);
                if (activePage) {
                    activePage.classList.add('active');
                }

                // Atualizar o estado ativo dos links de navega√ß√£o
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === pageId && (link.classList.contains('nav-link') || link.classList.contains('mobile-nav-item'))) {
                        link.classList.add('active');
                    }
                });

                // A√ß√µes espec√≠ficas ao carregar cada p√°gina
                if (pageId === 'chat') {
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                } else if (pageId === 'categories-management') {
                    renderCategories();
                } else if (pageId === 'transactions') {
                    renderTransactions();
                    updateDashboardAndTransactionSummaries();
                } else if (pageId === 'goals-management') {
                    renderGoals();
                    updateDashboardAndTransactionSummaries();
                } else if (pageId === 'dashboard') {
                    updateDashboardAndTransactionSummaries();
                } else if (pageId === 'budget-management') {
                    renderBudgets();
                } else if (pageId === 'ai-config') {
                    aiPersonaInput.value = aiConfig.persona;
                    aiPersonalityInput.value = aiConfig.personality;
                }
            }

            // Fun√ß√£o para atualizar os cards de resumo no Dashboard e Transa√ß√µes
            function updateDashboardAndTransactionSummaries() {
                let totalIncome = 0;
                let totalExpenses = 0;
                let currentBalance = 0;

                transactions.forEach(t => {
                    // Transa√ß√µes de receita que N√ÉO S√ÉO dep√≥sito de meta contribuem para a receita geral
                    if (t.type === 'Receita' && (t.status === 'Recebido' || t.status === 'Pago') && !t.isGoalDeposit) { 
                        totalIncome += parseFloat(t.amount);
                    } else if (t.type === 'Despesa' && (t.status === 'Pago' || t.status === 'Recebido')) {
                        totalExpenses += parseFloat(t.amount);
                    }
                });
                currentBalance = totalIncome - totalExpenses;

                // Atualiza Dashboard
                dashboardCurrentBalance.textContent = formatCurrency(currentBalance);
                dashboardMonthlyIncome.textContent = formatCurrency(totalIncome);
                dashboardMonthlyExpenses.textContent = formatCurrency(totalExpenses);

                // Atualiza Resumo em Transa√ß√µes
                transactionsCurrentBalance.textContent = formatCurrency(currentBalance);
                transactionsTotalExpenses.textContent = formatCurrency(totalExpenses);

                // Atualiza Total Guardado (Metas)
                let totalGoalsSaved = goals.reduce((sum, goal) => sum + parseFloat(goal.currentSavedAmount), 0);
                transactionsTotalGoalsSaved.textContent = formatCurrency(totalGoalsSaved);
            }


            // --- Fun√ß√µes de Gerenciamento de Categorias ---

            // Fun√ß√£o para renderizar as categorias na lista
            function renderCategories(filter = '') {
                categoryListContainer.innerHTML = '';

                const filteredCategories = categories.filter(cat => 
                    cat.name.toLowerCase().includes(filter.toLowerCase())
                );

                if (filteredCategories.length === 0 && filter === '') {
                    categoryListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhuma categoria cadastrada. Adicione uma nova!</p>';
                } else if (filteredCategories.length === 0 && filter !== '') {
                    categoryListContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma categoria encontrada para "${filter}".</p>`;
                }

                filteredCategories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'bg-white p-4 rounded-lg shadow-sm flex items-center justify-between';
                    categoryItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-6 h-6 rounded-full mr-3" style="background-color: ${category.color};"></div>
                            <div>
                                <p class="font-medium text-lg">${category.name}</p>
                                <p class="text-sm text-gray-500">${category.type}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="text-gray-500 hover:text-blue-500 p-1 rounded-full edit-category-button" data-id="${category.id}">
                                <i class="fa-solid fa-pen-to-square text-lg"></i>
                            </button>
                            <button class="text-gray-500 hover:text-red-500 p-1 rounded-full delete-category-button" data-id="${category.id}">
                                <i class="fa-solid fa-trash-can text-lg"></i>
                            </button>
                        </div>
                    `;
                    categoryListContainer.appendChild(categoryItem);
                });
            }

            // Abre o modal de categoria
            function openCategoryModal(category = null) {
                categoryModal.classList.add('active');
                categorySaveStatusMessage.classList.add('hidden');

                if (category) {
                    categoryModalTitle.textContent = 'Editar Categoria';
                    categoryIdInput.value = category.id;
                    categoryNameInput.value = category.name;
                    document.querySelector(`input[name="category-type"][value="${category.type}"]`).checked = true;
                    selectedColorInput.value = category.color;
                } else {
                    categoryModalTitle.textContent = 'Adicionar Nova Categoria';
                    categoryIdInput.value = '';
                    categoryNameInput.value = '';
                    selectedColorInput.value = '#F8B1A0';
                    document.querySelector(`input[name="category-type"][value="Despesa"]`).checked = true;
                }
                updateColorPaletteSelection(selectedColorInput.value);
            }

            // Fecha o modal de categoria
            function closeCategoryModal() {
                categoryModal.classList.remove('active');
                categoryForm.reset();
                categorySaveStatusMessage.classList.add('hidden');
            }

            // Exibe mensagem de status para salvar categoria
            function displayCategorySaveStatus(message, type = 'info') {
                categorySaveStatusMessage.textContent = message;
                categorySaveStatusMessage.classList.remove('hidden', 'text-green-700', 'text-red-700', 'text-blue-700');
                if (type === 'success') {
                    categorySaveStatusMessage.classList.add('text-green-700');
                } else if (type === 'error') {
                    categorySaveStatusMessage.classList.add('text-red-700');
                } else {
                    categorySaveStatusMessage.classList.add('text-blue-700');
                }
                setTimeout(() => {
                    categorySaveStatusMessage.classList.add('hidden');
                }, 3000);
            }

            // Lida com o envio do formul√°rio de categoria
            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = categoryIdInput.value;
                const name = categoryNameInput.value.trim();
                const type = document.querySelector('input[name="category-type"]:checked').value;
                const color = selectedColorInput.value;

                if (!name) {
                    console.warn("Nome da categoria √© obrigat√≥rio.");
                    displayCategorySaveStatus('Nome da categoria √© obrigat√≥rio!', 'error');
                    return;
                }

                if (id) {
                    const index = categories.findIndex(cat => cat.id === id);
                    if (index !== -1) {
                        categories[index] = { id, name, type, color };
                    }
                } else {
                    categories.push({ id: generateUUID(), name, type, color });
                }
                await saveCategories();
                if(transactionModal.classList.contains('active')) {
                    populateTransactionCategories(document.querySelector('input[name="transaction-type"]:checked').value);
                }
            });

            // Lida com cliques nos bot√µes de editar/excluir categorias (delega√ß√£o de eventos)
            categoryListContainer.addEventListener('click', (e) => {
                if (e.target.closest('.edit-category-button')) {
                    const id = e.target.closest('.edit-category-button').dataset.id;
                    const categoryToEdit = categories.find(cat => cat.id === id);
                    if (categoryToEdit) {
                        openCategoryModal(categoryToEdit);
                    }
                } else if (e.target.closest('.delete-category-button')) {
                    const id = e.target.closest('.delete-category-button').dataset.id;
                    showConfirmationModal(
                        "Confirmar Exclus√£o",
                        "Tem certeza que deseja excluir esta categoria? Todas as transa√ß√µes associadas a ela ficar√£o sem categoria.",
                        async () => {
                            categories = categories.filter(cat => cat.id !== id);
                            const transactionsToUpdate = transactions.filter(t => t.categoryId === id);
                            for (const t of transactionsToUpdate) {
                                t.categoryId = 'unknown';
                                await saveTransaction(t);
                            }
                            await saveCategories();
                            if(transactionModal.classList.contains('active')) {
                                populateTransactionCategories(document.querySelector('input[name="transaction-type"]:checked').value);
                            }
                        }
                    );
                }
            });

            // Popula o seletor de cores e adiciona listeners
            function populateColorPalette() {
                colorPalette.innerHTML = '';
                categoryColors.forEach(color => {
                    const colorCircle = document.createElement('div');
                    colorCircle.className = 'color-circle';
                    colorCircle.style.backgroundColor = color;
                    colorCircle.dataset.color = color;
                    if (color === selectedColorInput.value) {
                        colorCircle.classList.add('selected');
                    }
                    colorCircle.addEventListener('click', () => {
                        selectedColorInput.value = color;
                        updateColorPaletteSelection(color);
                    });
                    colorPalette.appendChild(colorCircle);
                });
            }

            // Atualiza a sele√ß√£o visual na paleta de cores
            function updateColorPaletteSelection(selectedColor) {
                document.querySelectorAll('.color-circle').forEach(circle => {
                    circle.classList.remove('selected');
                    if (circle.dataset.color === selectedColor) {
                        circle.classList.add('selected');
                    }
                });
            }


            // --- Fun√ß√µes de Gerenciamento de Transa√ß√µes ---

            // Fun√ß√£o para popular o dropdown de categorias (e metas para receita) no modal de transa√ß√µes
            function populateTransactionCategories(transactionType = null) {
                transactionCategorySelect.innerHTML = '<option value="">Selecione uma Categoria</option>';

                if (transactionType === 'Despesa') {
                    const expenseCategories = categories.filter(cat => cat.type === 'Despesa');
                    expenseCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name; 
                        transactionCategorySelect.appendChild(option);
                    });
                } else if (transactionType === 'Receita') {
                    // Grupo para categorias de receita normais
                    const optgroupCategories = document.createElement('optgroup');
                    optgroupCategories.label = 'Categorias de Receita';
                    const incomeCategories = categories.filter(cat => cat.type === 'Receita');
                    if (incomeCategories.length > 0) {
                        incomeCategories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.id;
                            option.textContent = cat.name;
                            optgroupCategories.appendChild(option);
                        });
                        transactionCategorySelect.appendChild(optgroupCategories);
                    }

                    // Grupo para metas financeiras
                    const optgroupGoals = document.createElement('optgroup');
                    optgroupGoals.label = 'Metas Financeiras';
                    if (goals.length > 0) {
                        goals.forEach(goal => {
                            const option = document.createElement('option');
                            option.value = `goal-${goal.id}`;
                            option.textContent = `Meta: ${goal.name} (Alvo: ${formatCurrency(goal.targetAmount)})`;
                            optgroupGoals.appendChild(option);
                        });
                        transactionCategorySelect.appendChild(optgroupGoals);
                    }
                    
                    if (incomeCategories.length === 0 && goals.length === 0) {
                        transactionCategorySelect.innerHTML += '<option value="" disabled>Nenhuma categoria ou meta dispon√≠vel</option>';
                    }
                }
            }


            // Renderiza as transa√ß√µes
            function renderTransactions() {
                transactionsListContainer.innerHTML = `
                    <div class="absolute left-3 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                `; 

                if (transactions.length === 0) {
                    transactionsListContainer.innerHTML += '<p class="text-center text-gray-500 py-4" id="no-transactions-message">Nenhuma transa√ß√£o cadastrada ainda.</p>';
                    return;
                }

                const groupedTransactions = transactions.reduce((acc, transaction) => {
                    const date = transaction.date;
                    if (!acc[date]) {
                        acc[date] = [];
                    }
                    acc[date].push(transaction);
                    return acc;
                }, {});

                const sortedDates = Object.keys(groupedTransactions).sort((a, b) => new Date(b) - new Date(a));

                sortedDates.forEach(date => {
                    const dateGroupDiv = document.createElement('div');
                    dateGroupDiv.className = 'mb-6 relative pl-8';

                    const formattedDate = new Date(date + 'T12:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });

                    dateGroupDiv.innerHTML = `
                        <div class="timeline-bullet-date">
                            <i class="fa-solid fa-calendar-days text-sm"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-3 ml-2">${formattedDate}</h3>
                        <div class="space-y-3"></div>
                    `;
                    const transactionsForDateDiv = dateGroupDiv.querySelector('.space-y-3');

                    groupedTransactions[date].sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA.getTime() === dateB.getTime()) {
                            return a.description.localeCompare(b.description);
                        }
                        return dateB - dateA;
                        // Corre√ß√£o para ordenar tamb√©m por hora se dispon√≠vel, ou descri√ß√£o
                    }).forEach(transaction => {
                        let categoryName = 'Categoria Desconhecida';
                        let bulletColor = '#9E9E9E';
                        
                        // Se for um dep√≥sito para meta
                        if (transaction.isGoalDeposit && transaction.goalId) {
                            const goal = goals.find(g => g.id === transaction.goalId);
                            categoryName = `Dep√≥sito para Meta: ${goal ? goal.name : 'Desconhecida'}`;
                            bulletColor = '#42A5F5';
                        } else { // Categoria normal
                            const category = categories.find(cat => cat.id === transaction.categoryId);
                            if (category) {
                                categoryName = category.name;
                                bulletColor = category.color;
                            }
                        }

                        const amountColorClass = transaction.type === 'Receita' ? 'text-[var(--color-green-positive)]' : 'text-[var(--color-red-negative)]';
                        const amountPrefix = transaction.type === 'Receita' ? '+' : '-';
                        
                        let bulletStyle = `background-color: transparent; border: 3px solid ${bulletColor};`;
                        if (transaction.status === 'Pago' || transaction.status === 'Recebido') {
                            bulletStyle = `background-color: ${bulletColor}; border: none;`;
                        }
                        
                        const statusIndicatorText = transaction.status === 'Pendente' ? '(Pendente)' : 
                                                    (transaction.type === 'Receita' && transaction.status === 'Recebido' ? '(Recebido)' : 
                                                    (transaction.type === 'Despesa' && transaction.status === 'Pago' ? '(Pago)' : ''));
                        const statusIndicatorClass = transaction.status === 'Pendente' ? 'text-orange-500' : '';
                        const statusIndicator = statusIndicatorText ? `<span class="${statusIndicatorClass} text-xs ml-2">${statusIndicatorText}</span>` : '';

                        const transactionItem = document.createElement('div');
                        transactionItem.className = `bg-white p-4 rounded-lg shadow-sm flex justify-between items-center relative pl-12`;
                        transactionItem.innerHTML = `
                            <div class="transaction-bullet" style="${bulletStyle}"></div>
                            <div>
                                <p class="font-medium">${transaction.description} ${statusIndicator}</p>
                                <p class="text-sm text-gray-500">${categoryName}</p>
                            </div>
                            <div class="text-right flex items-center space-x-2">
                                <p class="font-semibold ${amountColorClass}">${amountPrefix} ${formatCurrency(transaction.amount)}</p>
                                <button class="text-gray-400 hover:text-blue-500 p-1 rounded-full edit-transaction-button" data-id="${transaction.id}">
                                    <i class="fa-solid fa-pen-to-square text-base"></i>
                                </button>
                                <button class="text-gray-400 hover:text-red-500 p-1 rounded-full delete-transaction-button" data-id="${transaction.id}">
                                    <i class="fa-solid fa-trash-can text-base"></i>
                                </button>
                            </div>
                        `;
                        transactionsForDateDiv.appendChild(transactionItem);
                    });
                    transactionsListContainer.appendChild(dateGroupDiv);
                });
                if (transactions.length > 0) {
                    noTransactionsMessage.classList.add('hidden');
                } else {
                    noTransactionsMessage.classList.remove('hidden');
                }
            }

            // Fun√ß√£o para atualizar as op√ß√µes do dropdown de status com base no tipo de transa√ß√£o
            function updateTransactionStatusOptions(selectedType = null) {
                let currentType = selectedType;
                if (!currentType) {
                    currentType = document.querySelector('input[name="transaction-type"]:checked').value;
                }

                transactionStatusSelect.innerHTML = ''; 

                if (currentType === 'Despesa') {
                    const optionPaid = document.createElement('option');
                    optionPaid.value = 'Pago';
                    optionPaid.textContent = 'Pago';
                    transactionStatusSelect.appendChild(optionPaid);

                    const optionPending = document.createElement('option');
                    optionPending.value = 'Pendente';
                    optionPending.textContent = 'Pendente';
                    transactionStatusSelect.appendChild(optionPending);
                } else if (currentType === 'Receita') {
                    const optionReceived = document.createElement('option');
                    optionReceived.value = 'Recebido';
                    optionReceived.textContent = 'Recebido';
                    transactionStatusSelect.appendChild(optionReceived);

                    const optionPending = document.createElement('option');
                    optionPending.value = 'Pendente';
                    optionPending.textContent = 'Pendente';
                    transactionStatusSelect.appendChild(optionPending);
                }
                transactionStatusSelect.value = transactionStatusSelect.options[0] ? transactionStatusSelect.options[0].value : '';
            }

            // Abre o modal de transa√ß√£o
            function openTransactionModal(transaction = null) {
                transactionModal.classList.add('active');

                if (transaction) {
                    transactionModalTitle.textContent = 'Editar Transa√ß√£o';
                    transactionIdInput.value = transaction.id;
                    transactionDescriptionInput.value = transaction.description;
                    transactionAmountInput.value = (parseFloat(transaction.amount) * 100).toFixed(0); 
                    formatCurrencyInput(transactionAmountInput);
                    
                    transactionDateInput.value = transaction.date;
                    document.querySelector(`input[name="transaction-type"][value="${transaction.type}"]`).checked = true;
                    
                    updateTransactionStatusOptions(transaction.type); 
                    populateTransactionCategories(transaction.type);

                    if (transaction.isGoalDeposit) {
                        transactionCategorySelect.value = `goal-${transaction.goalId}`;
                    } else {
                        transactionCategorySelect.value = transaction.categoryId;
                    }
                    transactionStatusSelect.value = transaction.status;

                } else { // Adicionar nova transa√ß√£o
                    transactionModalTitle.textContent = 'Adicionar Nova Transa√ß√£o';
                    transactionIdInput.value = '';
                    transactionForm.reset();
                    transactionDateInput.valueAsDate = new Date();
                    transactionAmountInput.value = '';
                    
                    document.querySelector('input[name="transaction-type"][value="Despesa"]').checked = true;
                    populateTransactionCategories('Despesa');
                    updateTransactionStatusOptions('Despesa');
                }
            }

            // Fecha o modal de transa√ß√£o
            function closeTransactionModal() {
                transactionModal.classList.remove('active');
                transactionForm.reset();
            }

            // Lida com o envio do formul√°rio de transa√ß√£o
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = transactionIdInput.value;
                const description = transactionDescriptionInput.value.trim();
                
                const amountFormatted = transactionAmountInput.value.replace(/\./g, '').replace(',', '.');
                const amount = parseFloat(amountFormatted);

                const date = transactionDateInput.value;
                const type = document.querySelector('input[name="transaction-type"]:checked').value;
                const status = transactionStatusSelect.value;
                const selectedCategoryValue = transactionCategorySelect.value;

                let categoryId = selectedCategoryValue;
                let goalId = null; 
                let isGoalDeposit = false;

                // Valida√ß√£o b√°sica
                if (!description || isNaN(amount) || !date || !type || !status || !selectedCategoryValue) {
                    console.warn("Por favor, preencha todos os campos da transa√ß√£o corretamente.");
                    return;
                }

                // L√≥gica condicional para Categorias vs. Metas
                if (type === 'Receita' && selectedCategoryValue.startsWith('goal-')) {
                    goalId = selectedCategoryValue.substring(5);
                    isGoalDeposit = true;
                    categoryId = `goal_deposit`;
                    
                    // Encontra a meta e atualiza o valor guardado
                    const goal = goals.find(g => g.id === goalId);
                    if (goal) {
                        if (id) {
                            const oldTransaction = transactions.find(t => t.id === id);
                            if (oldTransaction) {
                                if (oldTransaction.isGoalDeposit && oldTransaction.goalId === goalId) {
                                    goal.currentSavedAmount -= parseFloat(oldTransaction.amount); 
                                    goal.currentSavedAmount += amount; 
                                } else if (oldTransaction.isGoalDeposit && oldTransaction.goalId !== goalId) {
                                    const oldGoal = goals.find(g => g.id === oldTransaction.goalId);
                                    if (oldGoal) oldGoal.currentSavedAmount -= parseFloat(oldTransaction.amount);
                                    goal.currentSavedAmount += amount;
                                } else {
                                    goal.currentSavedAmount += amount;
                                }
                            }
                        } else {
                            goal.currentSavedAmount += amount;
                        }
                        await saveGoals();
                    }
                }

                // Criar ou atualizar a transa√ß√£o
                const newTransaction = { id: id || generateUUID(), description, amount, date, type, categoryId, status, isGoalDeposit: isGoalDeposit, goalId: goalId || null };

                await saveTransaction(newTransaction);
                closeTransactionModal();
            });

            // Lida com cliques nos bot√µes de editar/excluir transa√ß√µes (delega√ß√£o de eventos)
            transactionsListContainer.addEventListener('click', (e) => {
                if (e.target.closest('.edit-transaction-button')) {
                    const id = e.target.closest('.edit-transaction-button').dataset.id;
                    const transactionToEdit = transactions.find(t => t.id === id);
                    if (transactionToEdit) {
                        openTransactionModal(transactionToEdit);
                    }
                } else if (e.target.closest('.delete-transaction-button')) {
                    const id = e.target.closest('.delete-transaction-button').dataset.id;
                    showConfirmationModal(
                        "Confirmar Exclus√£o",
                        "Tem certeza que deseja excluir esta transa√ß√£o?",
                        async () => {
                            const deletedTransaction = transactions.find(t => t.id === id);
                            if (deletedTransaction && deletedTransaction.isGoalDeposit && deletedTransaction.goalId) {
                                const goal = goals.find(g => g.id === deletedTransaction.goalId);
                                if (goal) {
                                    goal.currentSavedAmount -= parseFloat(deletedTransaction.amount);
                                    await saveGoals();
                                }
                            }
                            await deleteTransactionFromFirestore(id);
                        }
                    );
                }
            });

            // Listener para formatar o input de valor da transa√ß√£o
            transactionAmountInput.addEventListener('input', () => {
                formatCurrencyInput(transactionAmountInput);
            });

            // Adiciona listeners para os seletores de r√°dio de tipo de transa√ß√£o para atualizar as categorias e status
            transactionTypeRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const selectedType = event.target.value;
                    updateTransactionStatusOptions(selectedType);
                    populateTransactionCategories(selectedType);
                });
            });


            // --- Fun√ß√µes de Gerenciamento de Metas ---

            // Renderiza as metas na lista
            function renderGoals() {
                goalListContainer.innerHTML = '';

                if (goals.length === 0) {
                    goalListContainer.innerHTML = '<p class="text-center text-gray-500 py-4 col-span-full" id="no-goals-message">Nenhuma meta cadastrada ainda.</p>';
                    return;
                }
                
                noGoalsMessage.classList.add('hidden');

                goals.forEach(goal => {
                    const progress = (parseFloat(goal.currentSavedAmount) / parseFloat(goal.targetAmount)) * 100;
                    const progressBarColor = progress >= 100 ? 'bg-green-500' : (progress > 50 ? 'bg-blue-500' : 'bg-yellow-500');

                    const goalItem = document.createElement('div');
                    goalItem.className = 'bg-white p-5 rounded-lg shadow-md';
                    goalItem.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="font-semibold text-lg mb-1">${goal.name}</p>
                                <p class="text-sm text-gray-600">Alvo: ${formatCurrency(goal.targetAmount)}</p>
                                <p class="text-sm text-gray-600">Guardado: ${formatCurrency(goal.currentSavedAmount)}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="text-gray-500 hover:text-blue-500 p-1 rounded-full edit-goal-button" data-id="${goal.id}">
                                    <i class="fa-solid fa-pen-to-square text-lg"></i>
                                </button>
                                <button class="text-gray-500 hover:text-red-500 p-1 rounded-full delete-goal-button" data-id="${goal.id}">
                                    <i class="fa-solid fa-trash-can text-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-2">
                            <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(100, progress)}%"></div>
                        </div>
                        <p class="text-xs text-gray-500">${progress.toFixed(0)}% Conclu√≠do</p>
                    `;
                    goalListContainer.appendChild(goalItem);
                });
            }

            // Abre o modal de meta
            function openGoalModal(goal = null) {
                goalModal.classList.add('active');
                if (goal) {
                    goalModalTitle.textContent = 'Editar Meta Financeira';
                    goalIdInput.value = goal.id;
                    goalNameInput.value = goal.name;
                    goalTargetAmountInput.value = (parseFloat(goal.targetAmount) * 100).toFixed(0);
                    formatCurrencyInput(goalTargetAmountInput);
                    goalCurrentAmountInput.value = (parseFloat(goal.currentSavedAmount) * 100).toFixed(0);
                    formatCurrencyInput(goalCurrentAmountInput);
                } else {
                    goalModalTitle.textContent = 'Adicionar Nova Meta Financeira';
                    goalIdInput.value = '';
                    goalForm.reset();
                    goalTargetAmountInput.value = '';
                    goalCurrentAmountInput.value = '';
                }
            }

            // Fecha o modal de meta
            function closeGoalModal() {
                goalModal.classList.remove('active');
                goalForm.reset();
            }

            // Lida com o envio do formul√°rio de meta
            goalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = goalIdInput.value;
                const name = goalNameInput.value.trim();
                
                const targetAmountFormatted = goalTargetAmountInput.value.replace(/\./g, '').replace(',', '.');
                const targetAmount = parseFloat(targetAmountFormatted);
                const currentSavedAmountFormatted = goalCurrentAmountInput.value.replace(/\./g, '').replace(',', '.');
                const currentSavedAmount = parseFloat(currentSavedAmountFormatted);

                if (!name || isNaN(targetAmount) || isNaN(currentSavedAmount)) {
                    console.warn("Por favor, preencha todos os campos da meta corretamente.");
                    return;
                }

                if (currentSavedAmount > targetAmount) {
                    console.warn("O valor atual guardado n√£o pode ser maior que o valor alvo.");
                    return;
                }

                if (id) {
                    const index = goals.findIndex(g => g.id === id);
                    if (index !== -1) {
                        goals[index] = { id, name, targetAmount, currentSavedAmount };
                    }
                } else {
                    goals.push({ id: generateUUID(), name, targetAmount, currentSavedAmount });
                }
                await saveGoals();
                if(transactionModal.classList.contains('active')) {
                    populateTransactionCategories(document.querySelector('input[name="transaction-type"]:checked').value);
                }
                closeGoalModal();
            });

            // Lida com cliques nos bot√µes de editar/excluir metas (delega√ß√£o de eventos)
            goalListContainer.addEventListener('click', (e) => {
                if (e.target.closest('.edit-goal-button')) {
                    const id = e.target.closest('.edit-goal-button').dataset.id;
                    const goalToEdit = goals.find(g => g.id === id);
                    if (goalToEdit) {
                        openGoalModal(goalToEdit);
                    }
                } else if (e.target.closest('.delete-goal-button')) {
                    const id = e.target.closest('.delete-goal-button').dataset.id;
                    showConfirmationModal(
                        "Confirmar Exclus√£o",
                        "Tem certeza que deseja excluir esta meta? Todas as transa√ß√µes associadas a ela ficar√£o sem meta.",
                        async () => {
                            const transactionsToUpdate = transactions.filter(t => t.isGoalDeposit && t.goalId === id);
                            for (const t of transactionsToUpdate) {
                                t.isGoalDeposit = false;
                                t.goalId = null;
                                t.categoryId = 'unknown_goal_removed';
                                await saveTransaction(t);
                            }
                            goals = goals.filter(g => g.id !== id);
                            await saveGoals();
                            if(transactionModal.classList.contains('active')) {
                                populateTransactionCategories(document.querySelector('input[name="transaction-type"]:checked').value);
                            }
                        }
                    );
                }
            });

            // Listeners para formatar os inputs de valor da meta
            goalTargetAmountInput.addEventListener('input', () => {
                formatCurrencyInput(goalTargetAmountInput);
            });
            goalCurrentAmountInput.addEventListener('input', () => {
                formatCurrencyInput(goalCurrentAmountInput);
            });


            // --- Fun√ß√µes de Gerenciamento de Or√ßamento ---
            function renderBudgets() {
                budgetListContainer.innerHTML = '';
                if (budgets.length === 0) {
                    budgetListContainer.innerHTML = '<p class="text-center text-gray-500 py-4 col-span-full" id="no-budgets-message">Nenhum or√ßamento configurado ainda.</p>';
                    return;
                }
                noBudgetsMessage.classList.add('hidden');

                budgets.forEach(budget => {
                    const actualSpent = transactions.filter(t => 
                            t.categoryId === budget.categoryId && t.type === 'Despesa' && (t.status === 'Pago' || t.status === 'Recebido')
                        ).reduce((sum, t) => sum + parseFloat(t.amount), 0);

                    const percentage = (actualSpent / budget.budgetedAmount) * 100;
                    let progressBarColor = 'bg-blue-500';
                    let percentageTextColor = 'text-gray-500';

                    if (percentage >= 100) {
                        progressBarColor = 'bg-red-500';
                        percentageTextColor = 'text-red-500';
                    } else if (percentage > 75) {
                        progressBarColor = 'bg-yellow-500';
                    }

                    const displayPercentage = Math.min(100, percentage);
                    const remainingBudget = budget.budgetedAmount - actualSpent;
                    const remainingColor = remainingBudget >= 0 ? 'text-green-600' : 'text-red-600';
                    const remainingText = remainingBudget >= 0 ? `Restante: ${formatCurrency(remainingBudget)}` : `Estourou: ${formatCurrency(Math.abs(remainingBudget))}`;

                    const budgetItem = document.createElement('div');
                    budgetItem.className = 'bg-white p-5 rounded-lg shadow-md';
                    budgetItem.innerHTML = `
                        <p class="font-semibold text-lg mb-2">${budget.categoryName}</p>
                        <p class="text-sm text-gray-600">Or√ßado: ${formatCurrency(budget.budgetedAmount)}</p>
                        <p class="text-sm text-gray-600 mb-3">Gasto: ${formatCurrency(actualSpent)}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                            <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${displayPercentage}%"></div>
                        </div>
                        <p class="text-xs ${percentageTextColor}">${percentage.toFixed(0)}% do Or√ßamento</p>
                        <p class="text-xs ${remainingColor}">${remainingText}</p>
                        <div class="mt-3 flex justify-end space-x-2">
                            <button class="text-gray-500 hover:text-blue-500 p-1 rounded-full edit-budget-button" data-id="${budget.id}">
                                <i class="fa-solid fa-pen-to-square text-lg"></i>
                            </button>
                            <button class="text-gray-500 hover:text-red-500 p-1 rounded-full delete-budget-button" data-id="${budget.id}">
                                <i class="fa-solid fa-trash-can text-lg"></i>
                            </button>
                        </div>
                    `;
                    budgetListContainer.appendChild(budgetItem);
                });
            }

            // --- Fun√ß√µes de Otimiza√ß√£o de Or√ßamento com IA (NOVA) ---
            async function openBudgetOptimizationModal() {
                budgetOptimizationModal.classList.add('active');
                budgetOptimizationText.innerHTML = '';
                budgetOptimizationLoadingIndicator.classList.remove('hidden');

                if (!isGeminiApiReady || !geminiApiKey) {
                    budgetOptimizationText.innerHTML = '<p class="text-red-500">O assistente de IA n√£o est√° configurado. Por favor, insira sua chave de API Gemini nas "Mais Op√ß√µes".</p>';
                    budgetOptimizationLoadingIndicator.classList.add('hidden');
                    return;
                }

                let budgetDataString = "";
                if (budgets.length > 0) {
                    budgetDataString += "<strong>Or√ßamentos configurados:</strong><br><br>";
                    budgets.forEach(budget => {
                        const actualSpent = transactions.filter(t => 
                            t.categoryId === budget.categoryId && t.type === 'Despesa' && (t.status === 'Pago' || t.status === 'Recebido')
                        ).reduce((sum, t) => sum + parseFloat(t.amount), 0);
                        const remaining = budget.budgetedAmount - actualSpent;
                        budgetDataString += `- Categoria: ${budget.categoryName}, Or√ßado: ${formatCurrency(budget.budgetedAmount)}, Gasto Real: ${formatCurrency(actualSpent)}, Saldo: ${formatCurrency(remaining)}<br>`;
                    });
                } else {
                    budgetDataString += "Nenhum or√ßamento configurado. Por favor, configure alguns or√ßamentos para obter sugest√µes.<br>";
                }
                budgetDataString += "<br>--- Fim dos Dados de Or√ßamento ---<br><br>";

                const optimizationPrompt =
                    `Com base nos seguintes dados de or√ßamento do usu√°rio, forne√ßa sugest√µes claras e acion√°veis para otimizar os gastos e gerenciar melhor o dinheiro. ` +
                    `Seja direto, pr√°tico e objetivo, como um consultor financeiro que n√£o hesita em apontar onde o usu√°rio pode melhorar. ` +
                    `Use t√≠tulos em negrito (<strong>), listas n√£o ordenadas (<ul>, <li>) e quebras de linha (<br>). ` +
                    `NUNCA use Markdown (*, **, _, #, etc.). ` +
                    `Aqui est√£o os dados: <br><br>${budgetDataString}`;

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: optimizationPrompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 800
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        ]
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponseText = result.candidates[0].content.parts[0].text;
                        budgetOptimizationText.innerHTML = aiResponseText;
                    } else if (result.error) {
                        budgetOptimizationText.innerHTML = `<p class="text-red-500">Erro da API: ${result.error.message || 'Erro desconhecido da API Gemini.'}</p>`;
                        console.error('Erro da API Gemini para Otimiza√ß√£o de Or√ßamento:', result.error);
                    } else {
                        budgetOptimizationText.innerHTML = '<p class="text-red-500">N√£o foi poss√≠vel gerar sugest√µes de otimiza√ß√£o de or√ßamento neste momento.</p>';
                    }
                } catch (error) {
                    budgetOptimizationText.innerHTML = `<p class="text-red-500">Erro ao comunicar com a IA para otimiza√ß√£o. Verifique sua conex√£o. Detalhes: ${error.message || 'Erro desconhecido'}</p>`;
                    console.error('Erro ao chamar a API Gemini para Otimiza√ß√£o de Or√ßamento:', error);
                } finally {
                    budgetOptimizationLoadingIndicator.classList.add('hidden');
                }
            }

            function closeBudgetOptimizationModal() {
                budgetOptimizationModal.classList.remove('active');
            }


            // --- Fun√ß√µes do Chat com IA ---
            function appendMessage(sender, text, type = 'text') {
                const messageDiv = document.createElement('div');
                const bubbleDiv = document.createElement('div');

                if (sender === 'user') {
                    messageDiv.className = 'flex justify-end';
                    bubbleDiv.className = 'bg-[var(--color-blue-primary)] text-white p-3 rounded-xl rounded-br-none max-w-xs md:max-w-md shadow-sm';
                } else { // sender === 'ai' or 'model'
                    messageDiv.className = 'flex justify-start';
                    bubbleDiv.className = 'bg-gray-100 text-gray-800 p-3 rounded-xl rounded-bl-none max-w-xs md:max-w-md shadow-sm';
                    if (type === 'error') {
                        bubbleDiv.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-400');
                    }
                }

                // Usamos innerHTML para renderizar tags HTML b√°sicas que o modelo de IA pode gerar
                bubbleDiv.innerHTML = text; 
                messageDiv.appendChild(bubbleDiv);
                chatMessagesDiv.appendChild(messageDiv);

                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            }

            // Fun√ß√£o para obter dados financeiros formatados para a IA
            function getFinancialDataForAI() {
                let dataString = "";

                // Adicionar Categorias
                dataString += "<strong>Categorias Cadastradas:</strong><br><br>";
                if (categories.length > 0) {
                    categories.forEach(cat => {
                        dataString += `- ${cat.name} (Tipo: ${cat.type})<br>`; 
                    });
                } else {
                    dataString += "Nenhuma categoria cadastrada.<br>";
                }
                dataString += "<br>";

                // Adicionar Metas Financeiras
                dataString += "<strong>Metas Financeiras:</strong><br><br>";
                if (goals.length > 0) {
                    goals.forEach(goal => {
                        const progress = (parseFloat(goal.currentSavedAmount) / parseFloat(goal.targetAmount)) * 100;
                        dataString += `- ${goal.name}: Alvo ${formatCurrency(goal.targetAmount)}, Guardado ${formatCurrency(goal.currentSavedAmount)} (${progress.toFixed(0)}%)<br>`;
                    });
                } else {
                    dataString += "Nenhuma meta financeira cadastrada.<br>";
                }
                dataString += "<br>";

                // Adicionar Or√ßamentos
                dataString += "<strong>Or√ßamentos por Categoria:</strong><br><br>";
                if (budgets.length > 0) {
                    budgets.forEach(budget => {
                        const actualSpent = transactions.filter(t => 
                            t.categoryId === budget.categoryId && t.type === 'Despesa' && (t.status === 'Pago' || t.status === 'Recebido')
                        ).reduce((sum, t) => sum + parseFloat(t.amount), 0);
                        const remaining = budget.budgetedAmount - actualSpent;
                        dataString += `- ${budget.categoryName}: Or√ßado ${formatCurrency(budget.budgetedAmount)}, Gasto ${formatCurrency(actualSpent)}, Restante ${formatCurrency(remaining)}<br>`;
                    });
                } else {
                    dataString += "Nenhum or√ßamento configurado.<br>";
                }
                dataString += "<br>";

                // Adicionar Transa√ß√µes Recentes (ex: √∫ltimas 10 ou do m√™s atual)
                dataString += "<strong>√öltimas Transa√ß√µes (Recentes):</strong><br><br>";
                if (transactions.length > 0) {
                    // Ordenar por data mais recente
                    const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                    const recentTransactions = sortedTransactions.slice(0, 10); // Pegar as √∫ltimas 10

                    recentTransactions.forEach(t => {
                        let categoryDisplay = '';
                        if (t.isGoalDeposit && t.goalId) {
                            const goal = goals.find(g => g.id === t.goalId);
                            categoryDisplay = `(Meta: ${goal ? goal.name : 'Desconhecida'})`;
                        } else {
                            const category = categories.find(cat => cat.id === t.categoryId);
                            if (category) {
                                categoryDisplay = `(Categoria: ${category.name})`;
                            } else {
                                categoryDisplay = `(Categoria: Desconhecida)`;
                            }
                        }
                        const amountPrefix = t.type === 'Receita' ? '+' : '-';
                        dataString += `- ${new Date(t.date + 'T12:00:00').toLocaleDateString('pt-BR')}: ${t.description}, ${amountPrefix} ${formatCurrency(t.amount)} ${categoryDisplay} [Status: ${t.status}]<br>`;
                    });
                } else {
                    dataString += "Nenhuma transa√ß√£o registrada.<br>";
                }
                dataString += "<br>--- Fim dos Dados Financeiros ---<br><br>";
                return dataString;
            }


            async function sendChatMessage(userMessage) {
                if (isSendingMessage) {
                    return; 
                }

                if (userMessage.trim() === '') return;

                // Check if the Gemini API is confirmed ready
                if (!isGeminiApiReady || !geminiApiKey) {
                    appendMessage('ai', 'O assistente de IA n√£o est√° configurado. Por favor, insira sua chave de API Gemini nas "Mais Op√ß√µes".', 'error');
                    console.error("Gemini API not ready to send message or API key missing.");
                    return;
                }

                isSendingMessage = true;
                appendMessage('user', userMessage);
                chatInput.value = '';
                chatLoadingIndicator.classList.remove('hidden');

                const baseSystemInstruction =
                    `Voc√™ √© meu assistente financeiro pessoal, especializado em organiza√ß√£o de gastos, planejamento financeiro e educa√ß√£o financeira. Acompanho seus dados em tempo real e uso regras como a 50-30-20 para te ajudar a tomar decis√µes mais inteligentes com o seu dinheiro. Meu papel √© analisar suas entradas e sa√≠das, identificar padr√µes, te avisar quando voc√™ sair do ideal e propor ajustes pr√°ticos. Se tiver dinheiro sobrando, mostro como usar com intelig√™ncia. Se faltar, te mostro onde cortar. Se voc√™ n√£o tiver registrado seus gastos do dia ou n√£o tiver dados o suficiente, vou te lembrar de atualizar. Sem informa√ß√£o, n√£o consigo te orientar. Meu objetivo √© ser o c√©rebro da sua vida financeira ‚Äî mas preciso que voc√™ alimente ele.` +
                    `\n\nSua personalidade: Direto e firme. Quando tiver que dar uma not√≠cia ruim ou um feedback direto, n√£o floreie, v√° direto ao ponto. Ap√≥s entregar a realidade, seja construtivo e ofere√ßa sugest√µes claras para melhorar. Se o usu√°rio n√£o tiver dados suficientes para uma an√°lise aprofundada, informe de forma clara que mais dados s√£o necess√°rios. Sua fun√ß√£o √© educar e otimizar, n√£o suavizar a realidade financeira. Use emojis com modera√ß√£o e apenas para dar um leve toque de leveza ap√≥s uma informa√ß√£o s√©ria ou para real√ßar um ponto positivo/a√ß√£o recomendada.` +
                    `\n\nPadr√µes de Resposta e Intera√ß√£o:` +
                    `\n- <strong>Sem Markdown</strong>: NUNCA use *, **, _, #, ou qualquer outro caractere Markdown. Use HTML b√°sico para formata√ß√£o: <strong> para negrito, <br> para quebra de linha, <ul> para listas n√£o ordenadas, e <li> para itens de lista. Para listas, use tra√ßos simples como marcadores: "- Item 1".<br>` +
                    `\n- <strong>Respostas enxutas e √∫teis</strong>: N√£o jogue informa√ß√µes em excesso. Sempre responda apenas o necess√°rio, com clareza e objetividade.<br>` +
                    `\n- <strong>Mostre apenas o necess√°rio</strong>: Se for relevante para a pergunta, mostre apenas o essencial para ajudar na tomada de decis√£o. Por exemplo: "Voc√™ gastou R$ 300 com Ifood este m√™s. Isso √© 30% do seu sal√°rio de R$ 1.000."<br>` +
                    `\n- <strong>Nunca mostre dados t√©cnicos sem necessidade</strong>: N√£o exiba c√≥digos de cor, tipos de ID, ou estruturas internas de dados (como isGoalDeposit, categoryId, goalId), a n√£o ser que o usu√°rio pe√ßa diretamente por detalhes t√©cnicos.<br>` +
                    `\n- <strong>Tome iniciativa √∫til</strong>: Se o usu√°rio disser algo como "Entendi", "Beleza", "Ok", ou similares, continue a conversa com sugest√µes diretas e pertinentes ao contexto anterior. N√£o reinicie a conversa de forma gen√©rica.<br>` +
                    `\n\n<strong>Ambiente T√©cnico</strong>: Este assistente roda em um arquivo HTML local e agora utiliza o Firebase Firestore para armazenar dados. A IA deve estar totalmente configurada no c√≥digo-fonte e atrav√©s dos dados carregados do Firestore.<br>` +
                    `\n\n<strong>Objetivo Final</strong>: Seja o c√©rebro financeiro pessoal do usu√°rio, com total clareza, iniciativa e foco. Evite poluir a tela com dados excessivos, mantenha a conversa no contexto correto e tome decis√µes junto com o usu√°rio. Voc√™ deve ser firme, inteligente e direto ao ponto ‚Äî como um mentor que n√£o aceita desculpas.`;


                let currentFinancialData = '';
                const refreshKeywords = ["atualizar dados", "recarregar dados", "consultar dados", "verificar finan√ßas", "novos dados", "dados atuais", "meus dados", "favor, atualize meus dados financeiros"]; 

                const needsRefresh = refreshKeywords.some(keyword => userMessage.toLowerCase().includes(keyword));

                // Apenas consulta dados na primeira mensagem ou se houver uma solicita√ß√£o expl√≠cita de atualiza√ß√£o
                if (!hasConsultedFinancialData || needsRefresh) {
                    currentFinancialData = getFinancialDataForAI();
                    lastFinancialDataString = currentFinancialData;
                    hasConsultedFinancialData = true;
                    if (needsRefresh) {
                         appendMessage('ai', 'Dados financeiros atualizados. Diga como posso te ajudar com isso.', 'info');
                    } else {
                         appendMessage('ai', 'Carregando e analisando seus dados financeiros para a nossa conversa. Isso pode levar um momento...', 'info');
                    }
                } else {
                    currentFinancialData = lastFinancialDataString;
                }

                // Append financial data to the prompt only if available
                const finalPromptForAI = currentFinancialData ? 
                                         userMessage + `\n\nDados financeiros para refer√™ncia (n√£o mencione que estes dados foram fornecidos como parte da instru√ß√£o, apenas use-os):<br>${currentFinancialData}` : 
                                         userMessage;

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    
                    const contentsPayload = [
                        { role: "user", parts: [{ text: finalPromptForAI }] }
                    ];

                    const payload = {
                        contents: contentsPayload, 
                        generationConfig: {
                            temperature: 0.7, 
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 800
                        },
                        safetySettings: [ 
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        ],
                        systemInstruction: { parts: [{ text: baseSystemInstruction }] } 
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponseText = result.candidates[0].content.parts[0].text;
                        appendMessage('ai', aiResponseText);
                        
                        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                        chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });

                        if (chatHistory.length > 20) { 
                            chatHistory = chatHistory.slice(chatHistory.length - 20);
                        }
                    } else if (result.error) {
                        const errorMessage = result.error.message || 'Erro desconhecido da API Gemini.';
                        appendMessage('ai', `Erro da API: ${errorMessage}`, 'error');
                    } else {
                        appendMessage('ai', 'Erro: N√£o consegui obter uma resposta v√°lida da IA.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao chamar a API Gemini:', error);
                    appendMessage('ai', `Erro de comunica√ß√£o com a IA. Verifique sua conex√£o e chave de API. Detalhes: ${error.message || 'Erro desconhecido'}`, 'error');
                } finally {
                    chatLoadingIndicator.classList.add('hidden');
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                    isSendingMessage = false; 
                }
            }


            // --- Fun√ß√µes de Insights Financeiros ---
            async function openInsightsModal() {
                insightsModal.classList.add('active');
                insightsText.innerHTML = '';
                insightsLoadingIndicator.classList.remove('hidden');

                if (!isGeminiApiReady || !geminiApiKey) {
                    insightsText.innerHTML = '<p class="text-red-500">O assistente de IA n√£o est√° configurado. Por favor, insira sua chave de API Gemini nas "Mais Op√ß√µes".</p>';
                    insightsLoadingIndicator.classList.add('hidden');
                    return;
                }

                // Obt√©m os dados financeiros atualizados para os insights
                const financialData = getFinancialDataForAI();

                const insightPrompt =
                    `Analise os seguintes dados financeiros do usu√°rio e forne√ßa insights e recomenda√ß√µes √∫teis. ` +
                    `Seja objetivo, encorajador e focado em a√ß√µes pr√°ticas. ` +
                    `Estruture a resposta com t√≠tulos em negrito usando <strong>, listas n√£o ordenadas com <ul> e <li>, e quebras de linha com <br>. ` +
                    `Mantenha o tone de um assistente financeiro √∫til. ` +
                    `NUNCA use Markdown (*, **, _, #, etc.).` +
                    `Aqui est√£o os dados: <br><br>${financialData}`;

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: insightPrompt }] }],
                        generationConfig: {
                            temperature: 0.7, 
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 800
                        },
                        safetySettings: [ 
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        ]
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponseText = result.candidates[0].content.parts[0].text;
                        insightsText.innerHTML = aiResponseText;
                    } else if (result.error) {
                        insightsText.innerHTML = `<p class="text-red-500">Erro da API: ${result.error.message || 'Erro desconhecido da API Gemini.'}</p>`;
                        console.error('Erro da API Gemini para Insights:', result.error);
                    } else {
                        insightsText.innerHTML = '<p class="text-red-500">N√£o foi poss√≠vel gerar insights financeiros neste momento.</p>';
                    }
                } catch (error) {
                    insightsText.innerHTML = `<p class="text-red-500">Erro ao comunicar com a IA para insights. Verifique sua conex√£o. Detalhes: ${error.message || 'Erro desconhecido'}</p>`;
                    console.error('Erro ao chamar a API Gemini para Insights:', error);
                } finally {
                    insightsLoadingIndicator.classList.add('hidden');
                }
            }


            function closeInsightsModal() {
                insightsModal.classList.remove('active');
            }

            // --- Fun√ß√µes do Modal de Chave de API ---
            function openApiKeysModal() {
                apiKeysModal.classList.add('active');
                loadApiKey(); 
            }

            function closeApiKeysModal() {
                apiKeysModal.classList.remove('active');
            }

            function updateApiModalStatus(message, type = 'info') {
                apiModalStatusMessageDiv.classList.remove('hidden', 'bg-blue-100', 'border-blue-500', 'text-blue-700', 'bg-green-100', 'border-green-500', 'text-green-700', 'bg-red-100', 'border-red-500', 'text-red-700');
                
                if (type === 'info') {
                    apiModalStatusMessageDiv.classList.add('bg-blue-100', 'border-blue-500', 'text-blue-700');
                } else if (type === 'success') {
                    apiModalStatusMessageDiv.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                } else if (type === 'error') {
                    apiModalStatusMessageDiv.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                }
                
                apiModalMessageText.textContent = message;
                apiModalStatusMessageDiv.classList.remove('hidden');

                setTimeout(() => {
                    apiModalStatusMessageDiv.classList.add('hidden');
                }, 5000);
            }

            // Event listener para salvar as configura√ß√µes da IA
            if (saveAiConfigButton) {
                saveAiConfigButton.addEventListener('click', saveAiConfig);
            }

            // --- Configura√ß√£o e Inicializa√ß√£o do Firebase ---
            async function initializeFirebase() {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Listener para o estado de autentica√ß√£o
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid; // Define o userId com o UID do usu√°rio logado
                            isAuthReady = true;
                            loginScreen.classList.add('hidden');
                            appContent.classList.remove('hidden');
                            console.log("Usu√°rio autenticado:", userId);
                            // Adiciona um pequeno atraso para garantir que o contexto de autentica√ß√£o esteja totalmente propagado.
                            setTimeout(async () => {
                                await loadAllDataFromFirestore(); // Carrega dados ap√≥s autentica√ß√£o
                                showPage('dashboard'); // Redireciona para o dashboard ap√≥s login
                            }, 100); // Atraso de 100ms
                        } else {
                            userId = null; // Limpa userId se n√£o houver usu√°rio
                            isAuthReady = false;
                            loginScreen.classList.remove('hidden');
                            appContent.classList.add('hidden');
                            console.log("Usu√°rio n√£o autenticado. Mostrando tela de login.");
                        }
                    });

                    // Tenta autenticar com o token inicial fornecido pelo Canvas (se houver)
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Autentica√ß√£o com token inicial bem-sucedida.");
                        } catch (error) {
                            console.warn("Falha na autentica√ß√£o com token inicial. Tentando login an√¥nimo.", error);
                            await signInAnonymously(auth);
                            console.log("Login an√¥nimo bem-sucedido.");
                        }
                    } else {
                        // Se n√£o houver token, tente login an√¥nimo
                        await signInAnonymously(auth);
                        console.log("Nenhum token inicial fornecido. Login an√¥nimo bem-sucedido.");
                    }

                } catch (error) {
                    console.error("Erro ao inicializar Firebase:", error);
                    loginErrorMessage.textContent = `Erro cr√≠tico ao iniciar o aplicativo: ${error.message}`;
                    loginErrorMessage.classList.remove('hidden');
                }
            }

            // Event listener para o formul√°rio de login
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = loginEmailInput.value;
                    const password = loginPasswordInput.value;
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        loginErrorMessage.classList.add('hidden'); // Limpa a mensagem de erro se o login for bem-sucedido
                    } catch (error) {
                        let message = 'Erro ao fazer login. Verifique seu email e senha.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                            message = 'Email ou senha inv√°lidos.';
                        } else if (error.code === 'auth/invalid-email') {
                            message = 'Formato de email inv√°lido.';
                        } else if (error.code === 'auth/operation-not-allowed') {
                            message = 'A opera√ß√£o de login por e-mail/senha n√£o est√° ativada no seu projeto Firebase.';
                        }
                        loginErrorMessage.textContent = message;
                        loginErrorMessage.classList.remove('hidden');
                        console.error("Erro de login:", error.message);
                    }
                });
            }

            // Event listener para o bot√£o de logout (desktop)
            if (logoutButtonDesktop) {
                logoutButtonDesktop.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        console.log("Usu√°rio deslogado com sucesso.");
                        // UI will be handled by onAuthStateChanged listener
                    } catch (error) {
                        console.error("Erro ao deslogar:", error.message);
                    }
                });
            }

            // Event listener para o bot√£o de logout (mobile)
            if (logoutButtonMobile) {
                logoutButtonMobile.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        console.log("Usu√°rio deslogado com sucesso.");
                        // UI will be handled by onAuthStateChanged listener
                    } catch (error) {
                        console.error("Erro ao deslogar:", error.message);
                    }
                });
            }


            // Carregar a p√°gina inicial (dashboard) ao carregar (inicialmente oculto at√© logar)
            // showPage('dashboard'); // Esta chamada ser√° feita dentro do onAuthStateChanged

            // Atualizar o estado do chat ao carregar a p√°gina
            updateChatUIState();
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    const pageId = e.currentTarget.dataset.page;
                    showPage(pageId);
                });
            });

            // Event listeners para o chat
            if (sendButton) {
                sendButton.addEventListener('click', () => sendChatMessage(chatInput.value));
            }
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage(chatInput.value);
                    }
                });
            }
            // Event listener para o novo bot√£o de atualizar dados do chat
            if (refreshChatDataButton) {
                refreshChatDataButton.addEventListener('click', () => {
                    chatHistory = []; 
                    hasConsultedFinancialData = false;
                    sendChatMessage("Favor, atualize meus dados financeiros.");
                });
            }

            // Event listener para o novo bot√£o de Gerar Insights Financeiros
            const generateInsightsButton = document.getElementById('generate-insights-button');
            if (generateInsightsButton) {
                generateInsightsButton.addEventListener('click', openInsightsModal);
            }

            // Event listener para o novo bot√£o de Otimizar Or√ßamento
            if (optimizeBudgetButton) {
                optimizeBudgetButton.addEventListener('click', openBudgetOptimizationModal);
            }

            // Event listeners do Modal de Otimiza√ß√£o de Or√ßamento
            if (closeBudgetOptimizationModalButton) {
                closeBudgetOptimizationModalButton.addEventListener('click', closeBudgetOptimizationModal);
            }
            if (closeBudgetOptimizationButton) {
                closeBudgetOptimizationButton.addEventListener('click', closeBudgetOptimizationModal);
            }


            // Fun√ß√£o para atualizar o estado da UI do chat (habilitado/desabilitado)
            function updateChatUIState() {
                if (geminiApiKey.trim() !== '') {
                    isGeminiApiReady = true;
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    refreshChatDataButton.disabled = false;
                    chatInput.placeholder = "Digite sua mensagem...";
                    if (chatMessagesDiv.children.length === 1 && chatMessagesDiv.children[0].textContent.includes('Por favor, insira sua chave')) {
                        chatMessagesDiv.innerHTML = '';
                        appendMessage('ai', 'Assistente de IA pronto! Como posso ajudar?', 'info');
                    }
                } else {
                    isGeminiApiReady = false;
                    chatInput.disabled = true;
                    sendButton.disabled = true;
                    refreshChatDataButton.disabled = true;
                    chatInput.placeholder = "Assistente n√£o configurado...";
                }
            }


            // Event listeners do Modal de Categoria
            if (addCategoryButton) {
                addCategoryButton.addEventListener('click', () => openCategoryModal());
            }
            if (closeCategoryModalButton) {
                closeCategoryModalButton.addEventListener('click', closeCategoryModal);
            }
            if (cancelCategoryButton) {
                cancelCategoryButton.addEventListener('click', closeCategoryModal);
            }

            // Event listeners do Modal de Transa√ß√£o
            if (addNewTransactionButton) {
                addNewTransactionButton.addEventListener('click', () => openTransactionModal());
            }
            if (closeTransactionModalButton) {
                closeTransactionModalButton.addEventListener('click', closeTransactionModal);
            }
            if (cancelTransactionButton) {
                cancelTransactionButton.addEventListener('click', closeTransactionModal);
            }

            // Event listeners do Modal de Meta
            if (addNewGoalButton) {
                addNewGoalButton.addEventListener('click', () => openGoalModal());
            }
            if (closeGoalModalButton) {
                closeGoalModalButton.addEventListener('click', closeGoalModal);
            }
            if (cancelGoalButton) {
                cancelGoalButton.addEventListener('click', closeGoalModal);
            }

            // Event listeners do Modal de Insights
            if (closeInsightsModalButton) {
                closeInsightsModalButton.addEventListener('click', closeInsightsModal);
            }
            if (closeInsightsButton) {
                closeInsightsButton.addEventListener('click', closeInsightsModal);
            }

            // Event listeners do Modal de Chave de API
            if (apiManagementLink) {
                apiManagementLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openApiKeysModal();
                });
            }
            if (closeApiKeysModalButton) {
                closeApiKeysModalButton.addEventListener('click', closeApiKeysModal);
            }
            if (saveApiKeysModalButton) {
                saveApiKeysModalButton.addEventListener('click', saveApiKey);
            }


            populateColorPalette(); 
            
            transactionDateInput.valueAsDate = new Date();

            document.querySelectorAll('input[name="category-type"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    selectedColorInput.value = categoryColors[0];
                    updateColorPaletteSelection(selectedColorInput.value);
                });
            });
        });
    </script>

</body>
</html>
